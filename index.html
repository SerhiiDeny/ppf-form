<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Solicitar Presupuesto</title>
  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Supabase JS -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body { background:#121212; color:#fff; }
    .card { background:#1c1c1c; }
    .accent { color:#f5bf00; }
    .divider { height:3px; width:260px; background:#f5bf00; margin:16px auto 0; }
    label.small { font-size:.95rem; color:#cfcfcf; }
    .field, select, input[type="text"], input[type="number"], input[type="email"], input[type="tel"] {
      background:#111; color:#eee; border:1px solid #2a2a2a; border-radius:.35rem; padding:.55rem .7rem;
    }
    .field:disabled { opacity:.6; }
    .section-title { color:#eaeaea; font-weight:700; margin-top:.75rem; }
    .hint { color:#ff6a3d; text-align:center; }
    .btn-yellow { background:#f5bf00; color:#111; font-weight:700; border-radius:9999px; padding:.7rem 2.5rem; }
    .btn-yellow:disabled { opacity:.6; }
    .checkbox-row { display:flex; align-items:center; gap:.55rem; margin:.25rem 0; }
    .checkbox-row input { width:18px; height:18px; accent-color:#f5bf00; }
    .col-title { font-weight:700; color:#eaeaea; margin-bottom:.5rem; }
  </style>
</head>
<body>
  <div class="max-w-3xl mx-auto px-6 py-10">
    <h1 class="text-3xl font-extrabold text-center accent tracking-wide">SOLICITAR PRESUPUESTO</h1>

    <div class="card rounded-2xl p-6 mt-8 space-y-6">

      <!-- AUTO -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div>
          <label class="small block mb-1">Marca de coche <span class="accent">*</span></label>
          <select id="brand" class="w-full field">
            <option value="">Marca</option>
          </select>
        </div>
        <div>
          <label class="small block mb-1">Modelo de coche <span class="accent">*</span></label>
          <select id="model" class="w-full field">
            <option value="">Modelo</option>
          </select>
        </div>
        <div>
          <label class="small block mb-1">Año de fabricación <span class="accent">*</span></label>
          <select id="year" class="w-full field">
            <option value="">Año</option>
          </select>
        </div>
        <div>
          <label class="small block mb-1">Tipo de película <span class="accent">*</span></label>
          <select id="ppf" class="w-full field">
            <option value="">Seleccionar una opción</option>
          </select>
        </div>
      </div>

      <div class="text-center mt-2">
        <p class="hint font-semibold">Para calcular el costo, seleccione solo una opción<br/>1 o 2</p>
      </div>

      <div class="divider"></div>

      <!-- 1. Protección completa -->
      <div>
        <div class="section-title">1. Protección completa del coche</div>
        <select id="basic" class="w-full field mt-2">
          <option value="">Opciones de protección</option>
        </select>
      </div>

      <div class="divider"></div>

      <!-- 2. Protección por partes -->
      <div>
        <div class="section-title">2. Protección por partes del coche</div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mt-3">
          <!-- Frontal -->
          <div>
            <div class="col-title">Protección Frontal del Coche</div>
            <div id="grp-front"></div>
          </div>

          <!-- Trasera -->
          <div>
            <div class="col-title">Protección Trasera del Coche</div>
            <div id="grp-rear"></div>
          </div>

          <!-- Lateral -->
          <div>
            <div class="col-title">Protección Lateral del Coche</div>
            <div id="grp-side"></div>
          </div>

          <!-- Adicionales -->
          <div>
            <div class="col-title">Partes Adicionales del Coche</div>
            <div id="grp-extra"></div>
          </div>
        </div>
      </div>

      <!-- CONTACTO -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6 pt-4">
        <div>
          <label class="small block mb-1">Nombre <span class="accent">*</span></label>
          <input id="name_client" class="w-full field" type="text" placeholder="Nombre" />
        </div>
        <div>
          <label class="small block mb-1">Número de teléfono <span class="accent">*</span></label>
          <input id="phone" class="w-full field" type="tel" placeholder="700 00 00 00" />
        </div>
        <div class="md:col-span-2">
          <label class="small block mb-1">E-mail <span class="accent">*</span></label>
          <input id="email_client" class="w-full field" type="email" placeholder="email@dominio.com" />
        </div>
      </div>

      <div class="flex items-center gap-2 pt-2">
        <input id="promo" type="checkbox" class="w-4 h-4 accent-[#f5bf00]" />
        <label for="promo" class="text-slate-300">Quiero recibir tus ofertas de descuento</label>
      </div>

      <!-- SUBMIT -->
      <div class="text-center pt-4">
        <button id="submit" class="btn-yellow">Enviar</button>
        <div id="msg" class="mt-3 text-sm"></div>
      </div>
    </div>
  </div>

  <script>
    // ========= ЗАМЕНИ НА СВОИ ЗНАЧЕНИЯ =========
    const SUPABASE_URL = "https://pxgjwdhwxtzizhgotqur.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB4Z2p3ZGh3eHR6aXpoZ290cXVyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMwMDc4MjAsImV4cCI6MjA2ODU4MzgyMH0.H-31tjjjcNAn7jpMutYZN6LLImqdsVvYoJWxhYtER84";
    const WEBHOOK_URL = "https://primary-production-8e17.up.railway.app/webhook-test/0df53baa-d77f-49cf-b460-fb80afa7581e";
    // ==========================================

    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // Утилиты
    const byId = (id) => document.getElementById(id);
    const msg  = byId('msg');

    function setMsg(text, ok = true) {
      msg.textContent = text || '';
      msg.style.color = ok ? '#7CFC9A' : '#ff6a3d';
    }

    // Нормализация строк (для карты групп)
    const norm = (s) =>
      (s || '')
        .toLowerCase()
        .normalize('NFD').replace(/[\u0300-\u036f]/g, '')
        .trim();

    // ===== Годы: теперь именованная функция, чтобы вызывать после сброса
    function fillYears() {
      const y = byId('year');
      const now = new Date().getFullYear();
      const from = now + 1;
      const to   = 2000;
      const items = ['<option value="">Año</option>'];
      for (let yr = from; yr >= to; yr--) items.push(`<option value="${yr}">${yr}</option>`);
      y.innerHTML = items.join('');
    }

    // ===== ЗАГРУЗКА ДАННЫХ ИЗ SUPABASE =====

    async function loadBrands() {
      const el = byId('brand'); el.disabled = true;
      try {
        const { data } = await supabase
          .from('car_marcas')
          .select('marca')
          .order('marca', { ascending: true })
          .throwOnError();

        const brands = [...new Set((data || []).map(r => r.marca).filter(Boolean))];
        el.innerHTML = '<option value="">Marca</option>' +
          brands.map(b => `<option value="${b}">${b}</option>`).join('');
      } catch (e) {
        console.error('car_marcas[marca]:', e);
        el.innerHTML = '<option value="">Error cargando marcas</option>';
      } finally { el.disabled = false; }
    }

    async function loadModels(brand) {
      const el = byId('model');
      el.disabled = true;
      el.innerHTML = '<option value="">Modelo</option>';
      if (!brand) { el.disabled = false; return; }

      try {
        const { data } = await supabase
          .from('car_marcas')
          .select('modelo')
          .eq('marca', brand)
          .order('modelo', { ascending: true })
          .throwOnError();

        const models = [...new Set((data || []).map(r => r.modelo).filter(Boolean))];
        el.innerHTML = '<option value="">Modelo</option>' +
          models.map(m => `<option value="${m}">${m}</option>`).join('');
      } catch (e) {
        console.error('car_marcas[modelo]:', e);
        el.innerHTML = '<option value="">Error cargando modelos</option>';
      } finally { el.disabled = false; }
    }

    async function loadFilmTypes() {
      const el = byId('ppf'); el.disabled = true;
      try {
        const { data } = await supabase
          .from('film_coefficients')
          .select('tipo_ppf')
          .order('tipo_ppf', { ascending: true })
          .throwOnError();

        const types = [...new Set((data || []).map(r => r.tipo_ppf).filter(Boolean))];
        el.innerHTML = '<option value="">Seleccionar una opción</option>' +
          types.map(t => `<option value="${t}">${t}</option>`).join('');
      } catch (e) {
        console.error('film_coefficients.tipo_ppf:', e);
        el.innerHTML = '<option value="">Error cargando películas</option>';
      } finally { el.disabled = false; }
    }

    async function loadBasicOptions() {
      const el = byId('basic'); el.disabled = true;
      try {
        const { data } = await supabase
          .from('price')
          .select('service_name')
          .eq('type', 'basic')
          .throwOnError();

        const names = (data || []).map(r => r.service_name);
        el.innerHTML = '<option value="">Opciones de protección</option>' +
          names.map(n => `<option value="${n}">${n}</option>`).join('');
      } catch (e) {
        console.error('price basic:', e);
        el.innerHTML = '<option value="">Error cargando opciones</option>';
      } finally { el.disabled = false; }
    }

    const GROUP_MAP = {
      [norm("parachoques delantero")]: "front",
      [norm("capó")]: "front",
      [norm("aleta delantera derecha")]: "front",
      [norm("aleta delantera izquierda")]: "front",
      [norm("faro derecho")]: "front",
      [norm("faro izquierdo")]: "front",
      [norm("parachoques trasero")]: "rear",
      [norm("aleta trasera derecha")]: "rear",
      [norm("aleta trasera izquierda")]: "rear",
      [norm("puerta del maletero")]: "rear",
      [norm("puerta delantera derecha")]: "side",
      [norm("puerta delantera izquierda")]: "side",
      [norm("puerta trasera derecha")]: "side",
      [norm("puerta trasera izquierda")]: "side",
      [norm("retrovisor derecho")]: "side",
      [norm("retrovisor izquierdo")]: "side",
      [norm("talonera derecha")]: "side",
      [norm("talonera izquierda")]: "side",
      [norm("techo")]: "side",
      [norm("alerón")]: "extra",
      [norm("elementos decorativos interiores")]: "extra",
      [norm("elementos exteriores en negro piano")]: "extra",
      [norm("estante del parachoques trasero")]: "extra",
      [norm("molduras exterior de ventanas")]: "extra",
      [norm("pantalla")]: "extra",
      [norm("parabrisas")]: "extra",
      [norm("pilares del parabrisas")]: "extra",
      [norm("tira del techo")]: "extra"
    };

    function capitalizeWords(str){ return (str||'').replace(/\b\w/g, c => c.toUpperCase()); }
    function checkboxRow(name, id) {
      const formattedName = capitalizeWords(name);
      return `<label class="checkbox-row">
        <input type="checkbox" class="partial-item" value="${formattedName}" id="${id}">
        <span>${formattedName}</span>
      </label>`;
    }

    async function loadPartialGrouped() {
      const front = byId('grp-front');
      const rear  = byId('grp-rear');
      const side  = byId('grp-side');
      const extra = byId('grp-extra');
      front.innerHTML = rear.innerHTML = side.innerHTML = extra.innerHTML = '';

      try {
        const { data } = await supabase
          .from('price')
          .select('service_name')
          .eq('type', 'partial')
          .throwOnError();

        (data || []).forEach((r, idx) => {
          const name = r.service_name || '';
          const key  = GROUP_MAP[norm(name)] || 'extra';
          const id   = 'p-' + idx;
          const html = checkboxRow(name, id);

          if      (key === 'front') front.insertAdjacentHTML('beforeend', html);
          else if (key === 'rear')  rear.insertAdjacentHTML('beforeend',  html);
          else if (key === 'side')  side.insertAdjacentHTML('beforeend',  html);
          else                      extra.insertAdjacentHTML('beforeend', html);
        });
      } catch (e) {
        console.error('price partial:', e);
        front.innerHTML = '<div class="text-red-400 text-sm">Error cargando servicios</div>';
      }
    }

    // ===== СБОР / ОТПРАВКА / СБРОС =====
    function collectPayload() {
      const basic = byId('basic')?.value || '';
      const partial = Array.from(document.querySelectorAll('.partial-item:checked'))
        .map(i => i.value);

      return {
        name_client: byId('name_client')?.value?.trim() || '',
        email_client: byId('email_client')?.value?.trim() || '',
        phone: byId('phone')?.value?.trim() || '',
        marca: byId('brand')?.value || '',
        modelo: byId('model')?.value || '',
        año: byId('year')?.value || '',
        service_basic: basic,
        service_partial: partial.join(', '),
        marca_ppf: byId('ppf')?.value || '',
        check_promotion: byId('promo')?.checked ? 'Checked' : '',
        mode: 'text'
      };
    }

    async function resetForm() {
      // Очистить значения
      document.querySelectorAll('input, select').forEach(el => {
        if (el.type === 'checkbox' || el.type === 'radio') el.checked = false;
        else el.value = '';
      });

      // Плейсхолдеры в селектах
      byId('brand').innerHTML = '<option value="">Marca</option>';
      byId('model').innerHTML = '<option value="">Modelo</option>';
      byId('ppf').innerHTML   = '<option value="">Seleccionar una opción</option>';
      byId('basic').innerHTML = '<option value="">Opciones de protección</option>';

      // Чекбоксы-группы
      ['grp-front','grp-rear','grp-side','grp-extra'].forEach(id => byId(id).innerHTML = '');

      // Перезагрузить всё
      fillYears();
      await Promise.all([
        loadBrands(),
        loadFilmTypes(),
        loadBasicOptions(),
        loadPartialGrouped()
      ]);
    }

    async function submitForm() {
      setMsg('', true);
      const btn = byId('submit');
      btn.disabled = true;

      try {
        const payload = collectPayload();

        if (!payload.marca || !payload.modelo || !payload.año || !payload.marca_ppf ||
            !payload.name_client || !payload.email_client || !payload.phone) {
          throw new Error('Por favor, rellena los campos obligatorios marcados con *');
        }

        const res = await fetch(WEBHOOK_URL, {
          method: 'POST',
          headers: { 'Content-Type':'application/json' },
          body: JSON.stringify({ data: payload })
        });

        if (!res.ok) throw new Error('Webhook respondió con ' + res.status);

        setMsg('¡Formulario enviado con éxito!');
        await resetForm();               // <<< СБРОС И ПЕРЕЗАГРУЗКА
      } catch (e) {
        console.error('submit:', e);
        setMsg('Error: ' + (e?.message || e), false);
      } finally {
        btn.disabled = false;
      }
    }

    // ===== INIT =====
    async function init() {
      fillYears();
      await Promise.all([
        loadBrands(),
        loadFilmTypes(),
        loadBasicOptions(),
        loadPartialGrouped()
      ]);

      byId('brand')?.addEventListener('change', (e) => loadModels(e.target.value || ''));
      byId('submit')?.addEventListener('click', submitForm);
    }
    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
