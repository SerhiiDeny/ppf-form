<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Presupuesto Online - PPF Barcelona</title>
  <meta name="description" content="Calcula tu presupuesto de protecci√≥n PPF en menos de 2 minutos. Sin compromiso." />

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.1.6/dist/purify.min.js"></script>

  <!-- intl-tel-input -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/intl-tel-input@23.8.0/build/css/intlTelInput.min.css">
  <script src="https://cdn.jsdelivr.net/npm/intl-tel-input@23.8.0/build/js/intlTelInput.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/intl-tel-input@23.8.0/build/js/utils.js"></script>

  <style>
    :root{
      --bg:#0b0b0b;
      --card:#111;
      --line:#242424;
      --muted:#cbd5e1;
      --accent:#f5bf00;
      --ok:#16a34a;
      --err:#ef4444;
      --warn:#f59e0b;
    }
    body{ background:var(--bg); color:#fff; }
    .field{
      background:#0f0f0f;
      border:1px solid var(--line);
      border-radius:14px;
      padding:12px 14px;
      outline:none;
    }
    .field:focus{ border-color:var(--accent); box-shadow:0 0 0 3px rgba(245,191,0,.15); }
    .btn-yellow{
      background:var(--accent);
      color:#111;
      border-radius:14px;
      padding:12px 16px;
      font-weight:800;
      border:1px solid rgba(255,255,255,.08);
      transition:transform .12s ease;
    }
    .btn-yellow:hover{ transform: translateY(-1px); }
    .btn-ghost{
      background:#111;
      border:1px solid var(--line);
      border-radius:14px;
      padding:12px 16px;
      font-weight:800;
      color:#fff;
    }
    .section-title{ font-size:18px; font-weight:900; }
    .dot{ width:10px; height:10px; border-radius:999px; background:#3a3a3a; }
    .dot.active{ background:var(--accent); }
    .sr-only{ position:absolute; left:-9999px; top:auto; width:1px; height:1px; overflow:hidden; }
    .warnbox{ border:1px solid rgba(245,191,0,.35); background:rgba(245,191,0,.08); border-radius:16px; padding:12px; }
    .warnbox .title{ font-weight:900; color:#ffe38d; }
    .ok{ color:var(--ok); }
    .error{ color:var(--err); }
    .accent{ color:var(--accent); font-weight:900; }
    .invalid{ border-color: rgba(239,68,68,.8) !important; box-shadow: 0 0 0 3px rgba(239,68,68,.12) !important; }
    .valid{ border-color: rgba(22,163,74,.8) !important; box-shadow: 0 0 0 3px rgba(22,163,74,.12) !important; }

    /* packages */
    .pkg{
      border:1px solid var(--line);
      background:#0f0f0f;
      border-radius:16px;
      padding:14px;
      font-weight:800;
      text-align:left;
      transition: transform .12s ease, border-color .12s ease;
    }
    .pkg:hover{ transform: translateY(-1px); border-color: rgba(245,191,0,.35); }
    .pkg.active{ border-color: rgba(245,191,0,.8); box-shadow: 0 0 0 3px rgba(245,191,0,.12); }

    /* tabs */
    .seg{ border:1px solid var(--line); background:#0f0f0f; }
    .seg button{ border-radius:14px; font-weight:900; }
    .seg button.active{ background:rgba(245,191,0,.14); border:1px solid rgba(245,191,0,.55); }

    /* check items */
    .check-row{
      border:1px solid var(--line);
      background:#0f0f0f;
      border-radius:16px;
      padding:12px 12px;
      display:flex;
      align-items:flex-start;
      gap:10px;
    }
    .check-row input{ margin-top:3px; width:18px; height:18px; }
    .check-row .name{ font-weight:800; line-height:1.2; }
    .check-row .desc{ font-size:12px; color:#a8b3c5; margin-top:2px; }

    .hidden{ display:none !important; }
  </style>
</head>

<body>
  <div id="form-top"></div>

  <main class="max-w-3xl mx-auto p-4 md:p-8">
    <!-- HERO -->
    <section class="rounded-2xl border border-[#2a2a2a] bg-[#0f0f0f] p-5 md:p-7 shadow-lg">
      <div class="flex items-start justify-between gap-3">
        <div>
          <h1 id="hero-title" class="text-2xl md:text-3xl font-black leading-tight">
            Presupuesto Online de PPF en 2 minutos
          </h1>
          <p id="hero-subtitle" class="text-slate-300 mt-2">
            Te ayudamos a elegir el nivel de protecci√≥n ideal. Sin compromiso.
          </p>
        </div>

        <div class="flex items-center gap-2 pt-1" aria-hidden="true">
          <span class="dot active" id="dot-1"></span>
          <span class="dot" id="dot-2"></span>
          <span class="dot" id="dot-3"></span>
          <span class="dot" id="dot-4"></span>
          <span class="dot" id="dot-5"></span>
        </div>
      </div>

      <div class="mt-4 flex items-center justify-between gap-3">
        <div id="step-label" class="text-sm text-slate-300">Paso 1 de 5</div>
        <div id="msg" class="text-sm"></div>
      </div>
    </section>

    <!-- FORM CARD -->
    <section class="rounded-2xl border border-[#2a2a2a] bg-[#0f0f0f] p-5 md:p-7 mt-4 shadow-lg">
      <!-- STEP 1 -->
      <section id="step-1" class="space-y-4">
        <h2 id="step1-title" class="section-title" tabindex="-1">1) Veh√≠culo</h2>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
          <div>
            <label class="text-sm text-slate-300" for="brand">
              <span id="lbl-brand">Marca</span>
              <span id="star-brand" class="accent">*</span>
            </label>
            <select id="brand" class="w-full field">
              <option value="">Cargando marcas...</option>
            </select>
          </div>

          <div>
            <label class="text-sm text-slate-300" for="model">
              <span id="lbl-model">Modelo</span>
              <span id="star-model" class="accent">*</span>
            </label>
            <select id="model" class="w-full field" disabled>
              <option value="">Selecciona una marca</option>
            </select>
          </div>

          <div>
            <label class="text-sm text-slate-300" for="year">
              <span id="lbl-year">A√±o</span>
              <span id="star-year" class="accent">*</span>
            </label>
            <select id="year" class="w-full field">
              <option value="">Cargando a√±os...</option>
            </select>
          </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
          <div id="wrap-center">
            <label class="text-sm text-slate-300" for="install_center">
              <span id="lbl-center">Centro</span>
              <span id="star-center" class="accent">*</span>
            </label>
            <select id="install_center" class="w-full field">
              <option value="">Cargando centros...</option>
            </select>
          </div>

          <div>
            <label class="text-sm text-slate-300" for="comment">
              <span id="lbl-comment">Comentario</span>
            </label>
            <textarea id="comment" rows="3" class="w-full field" placeholder="Opcional: color, urgencia, etc."></textarea>
          </div>
        </div>

        <div class="pt-2 space-y-3 md:space-y-0 md:flex md:items-center md:justify-between md:gap-3">
          <div class="text-sm text-slate-300" id="step1-sub">
            Selecciona marca, modelo, a√±o y centro para continuar.
          </div>

          <div class="flex gap-2">
            <button class="btn-yellow w-full md:w-auto" id="next-1" type="button">Continuar</button>
          </div>
        </div>

        <div id="step1-hint" class="text-sm error"></div>
      </section>

      <!-- STEP 2 -->
      <section id="step-2" class="space-y-4 hidden">
        <h2 id="step2-title" class="section-title" tabindex="-1">2) Tipo de servicio</h2>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
          <button id="choose-total" type="button" class="pkg">
            <div class="text-lg font-black" id="choose-total-title">Cobertura total</div>
            <div class="text-sm text-slate-300 mt-1" id="choose-total-desc">Paquetes recomendados</div>
          </button>

          <button id="choose-parts" type="button" class="pkg">
            <div class="text-lg font-black" id="choose-parts-title">Cobertura parcial</div>
            <div class="text-sm text-slate-300 mt-1" id="choose-parts-desc">Selecciona partes</div>
          </button>
        </div>

        <div class="pt-2 space-y-3 md:space-y-0 md:flex md:items-center md:justify-between md:gap-3">
          <div class="text-sm text-slate-300" id="step2-sub">Elige una opci√≥n para continuar.</div>

          <div class="grid grid-cols-2 gap-2 md:flex md:gap-2 md:justify-end">
            <button class="btn-ghost w-full md:w-auto" id="back-2" type="button">Atr√°s</button>
            <button class="btn-yellow w-full md:w-auto" id="next-2" type="button">Continuar</button>
          </div>
        </div>

        <div id="step2-hint" class="text-sm error"></div>
      </section>

      <!-- STEP 3 -->
      <section id="step-3" class="space-y-4 hidden">
        <h2 class="section-title" id="step3-title" tabindex="-1">3) Configuraci√≥n</h2>

        <!-- PACKAGES -->
        <div id="block-packages" class="space-y-3 hidden">
          <div class="rounded-xl border border-[#2a2a2a] bg-[#121212] p-4 space-y-3">
            <div class="font-extrabold" id="packages-title">Elige un paquete</div>
            <div class="text-sm text-slate-300" id="packages-desc">Selecciona un paquete para tener el precio base. El resto se ajusta contigo despu√©s.</div>
            <div id="packages-buttons" class="grid grid-cols-1 md:grid-cols-3 gap-3"></div>
          </div>

          <div class="rounded-xl border border-[#2a2a2a] bg-[#121212] p-4 space-y-3">
            <div class="font-extrabold" id="finish-title-pack">Tipo de cobertura</div>

            <select id="finish" class="w-full field">
              <option value="">Cargando opciones...</option>
            </select>

            <!-- Film brand (optional) -->
            <div id="wrap-film-brand" class="space-y-1">
              <label class="text-sm text-slate-300" for="film_brand">
                <span id="lbl-film-brand">Marca de la pel√≠cula (opcional)</span>
              </label>
              <select id="film_brand" class="w-full field">
                <option value="">Cargando marcas...</option>
              </select>
            </div>

            <div id="pack-warning-box" class="warnbox hidden space-y-2">
              <div class="title">‚ö†Ô∏è Importante</div>
              <div id="pack-warning-body" class="text-sm"></div>
            </div>
          </div>
        </div>

        <!-- PARTS (3B embedded) -->
        <div id="block-parts" class="space-y-3 hidden">
          <div class="rounded-xl border border-[#2a2a2a] bg-[#121212] p-4 space-y-3">
            <div>
              <h3 id="ui-title" class="text-lg font-extrabold">
                Selecci√≥n de partes <span class="accent">(Carrocer√≠a)</span>
              </h3>
              <p id="ui-subtitle" class="text-sm text-slate-300 mt-1"></p>
            </div>

            <div class="seg rounded-2xl p-1 flex gap-1" role="tablist" aria-label="Zonas">
              <button id="tab-frontal" class="w-full py-2 rounded-xl active" type="button" role="tab" aria-selected="true">Frontal</button>
              <button id="tab-lateral" class="w-full py-2 rounded-xl" type="button" role="tab" aria-selected="false">Lateral</button>
              <button id="tab-trasera" class="w-full py-2 rounded-xl" type="button" role="tab" aria-selected="false">Trasera</button>
            </div>

            <div id="parts-list" class="space-y-2"></div>
          </div>

          <div class="rounded-xl border border-[#2a2a2a] bg-[#121212] p-4 space-y-3">
            <div class="font-extrabold" id="finish-title-parts">Tipo de cobertura</div>

            <select id="finish_parts" class="w-full field">
              <option value="">Cargando opciones...</option>
            </select>

            <!-- Film brand (optional) -->
            <div id="wrap-film-brand-parts" class="space-y-1">
              <label class="text-sm text-slate-300" for="film_brand_parts">
                <span id="lbl-film-brand-parts">Marca de la pel√≠cula (opcional)</span>
              </label>
              <select id="film_brand_parts" class="w-full field">
                <option value="">Cargando marcas...</option>
              </select>
            </div>

            <div id="parts-warning-box" class="warnbox hidden space-y-2">
              <div class="title">‚ö†Ô∏è Importante</div>
              <div id="parts-warning-body" class="text-sm"></div>
            </div>
          </div>
        </div>

        <div class="pt-2 space-y-3 md:space-y-0 md:flex md:items-center md:justify-between md:gap-3">
          <div class="text-sm text-slate-300" id="step3-sub">Selecciona opciones para continuar.</div>

          <div class="grid grid-cols-2 gap-2 md:flex md:gap-2 md:justify-end">
            <button class="btn-ghost w-full md:w-auto" id="back-3" type="button">Atr√°s</button>
            <button class="btn-yellow w-full md:w-auto" id="next-3" type="button">Continuar</button>
          </div>
        </div>

        <div id="step3-hint" class="text-sm error"></div>
      </section>

      <!-- STEP 4 -->
      <section id="step-4" class="space-y-4 hidden">
        <h2 id="step4-title" class="section-title" tabindex="-1">4) Extras</h2>

        <div class="rounded-xl border border-[#2a2a2a] bg-[#121212] p-4 space-y-4">
          <div class="flex items-center justify-between gap-3">
            <div class="font-extrabold" id="extras-title">Extras</div>
            <label class="inline-flex items-center gap-2 text-sm">
              <input id="promo" type="checkbox" class="accent" />
              <span id="promo-label">Tengo promoci√≥n / c√≥digo</span>
            </label>
          </div>

          <div id="extras-list" class="space-y-2"></div>
        </div>

        <div class="rounded-xl border border-[#2a2a2a] bg-[#121212] p-4 space-y-4">
          <div class="font-extrabold" id="services-title">Servicios adicionales</div>
          <div id="services-list" class="space-y-2"></div>
        </div>

        <div class="pt-2 space-y-3 md:space-y-0 md:flex md:items-center md:justify-between md:gap-3">
          <div class="text-sm text-slate-300" id="step4-count">Ninguno seleccionado</div>

          <div class="grid grid-cols-2 gap-2 md:flex md:gap-2 md:justify-end">
            <button class="btn-ghost w-full md:w-auto" id="back-4" type="button">Atr√°s</button>
            <button class="btn-yellow w-full md:w-auto" id="next-4" type="button">Continuar</button>
          </div>
        </div>

        <div id="step4-hint" class="text-sm error"></div>
      </section>

      <!-- STEP 5 -->
      <section id="step-5" class="space-y-4 hidden">
        <h2 id="step5-title" class="section-title" tabindex="-1">5) Contacto</h2>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
          <div>
            <label class="text-sm text-slate-300" for="name_client">
              <span id="lbl-name">Nombre</span> <span class="accent">*</span>
            </label>
            <input id="name_client" class="w-full field" placeholder="Tu nombre" />
            <div id="name-hint" class="text-xs mt-1 error hidden"></div>
          </div>

          <div>
            <label class="text-sm text-slate-300" for="phone">
              <span id="lbl-phone">Tel√©fono</span> <span class="accent">*</span>
            </label>
            <input id="phone" class="w-full field" placeholder="+34 ..." />
            <div id="phone-hint" class="text-xs mt-1 error hidden"></div>
          </div>

          <div class="md:col-span-2">
            <label class="text-sm text-slate-300" for="email_client">
              <span id="lbl-email">Email</span> <span class="accent">*</span>
            </label>
            <input id="email_client" class="w-full field" placeholder="tu@email.com" />
            <div id="email-hint" class="text-xs mt-1 error hidden"></div>
          </div>
        </div>

        <div class="rounded-xl border border-[#2a2a2a] bg-[#121212] p-4 space-y-2">
          <label class="inline-flex items-start gap-3">
            <input id="consent" type="checkbox" class="mt-1" />
            <span id="privacy-text" class="text-sm text-slate-300">
              He le√≠do y acepto la <a href="#" class="underline">Pol√≠tica de privacidad</a>
            </span>
          </label>
          <div id="consent-hint" class="text-xs error hidden"></div>
        </div>

        <div class="rounded-xl border border-[#2a2a2a] bg-[#121212] p-4 space-y-3">
          <div class="font-extrabold" id="send-title">¬øC√≥mo prefieres recibir el presupuesto?</div>

          <div class="seg rounded-2xl p-1 flex gap-1" role="tablist" aria-label="Enviar">
            <button id="send-tab-email" class="w-full py-2 rounded-xl active" type="button" role="tab" aria-selected="true">üìß Email</button>
            <button id="send-tab-wa" class="w-full py-2 rounded-xl" type="button" role="tab" aria-selected="false">üì± WhatsApp</button>
          </div>

          <div id="send-desc" class="text-sm text-slate-300">
            Te enviaremos el presupuesto por el canal elegido.
          </div>
        </div>

        <div class="pt-2 space-y-3 md:space-y-0 md:flex md:items-center md:justify-between md:gap-3">
          <div class="text-sm text-slate-300" id="step5-sub">Revisa los datos y env√≠a.</div>

          <div class="grid grid-cols-2 gap-2 md:flex md:gap-2 md:justify-end">
            <button class="btn-ghost w-full md:w-auto" id="back-5" type="button">Atr√°s</button>
            <button class="btn-yellow w-full md:w-auto" id="submit" type="button">
              <span id="submit-text">Enviar presupuesto</span>
            </button>
          </div>
        </div>

        <div id="step5-hint" class="text-sm error"></div>
      </section>
    </section>
  </main>

  <script>
    // ----------------- CONFIG -----------------
    const SUPABASE_URL = "https://pxgjwdhwxtzizhgotqur.supabase.co";
    const SUPABASE_ANON_KEY = "YOUR_ANON_KEY_HERE";
    const WEBHOOK_URL = "https://primary-production-8e17.up.railway.app/webhook/9d3ac003-abf6-446b-a415-18ba2b4affb3";
    const PRIVACY_URL = "https://www.ppfbarcelona.es/pol%C3%ADtica-de-privacidad";

    // IMPORTANT: MUST match catalog form_key for film_finishes + ui_form_fields
    const FORM_KEY = "ppf_quote";

    // Supabase client
    const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // DOM helpers
    const byId = (id) => document.getElementById(id);

    const msgEl = byId('msg');
    const stepLabelEl = byId('step-label');

    const steps = [
      byId('step-1'),
      byId('step-2'),
      byId('step-3'),
      byId('step-4'),
      byId('step-5')
    ];

    const dots = [
      byId('dot-1'),
      byId('dot-2'),
      byId('dot-3'),
      byId('dot-4'),
      byId('dot-5')
    ];

    // intl-tel-input instance
    let iti = null;

    // Helpers
    const norm = (s) => (s || '').toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'').trim();

    function escapeHtml(text){
      const div = document.createElement('div');
      div.textContent = String(text ?? '');
      return div.innerHTML;
    }

    function setMsg(text, ok=true){
      msgEl.textContent = text || '';
      msgEl.className = ok ? 'text-sm ok' : 'text-sm error';
    }

    function blurActive(){
      try {
        if (document.activeElement && document.activeElement.blur) {
          document.activeElement.blur();
        }
      } catch(e){}
    }

    function announceToScreenReader(message){
      const el = document.createElement('div');
      el.setAttribute('role', 'status');
      el.setAttribute('aria-live', 'polite');
      el.className = 'sr-only';
      el.textContent = message;
      document.body.appendChild(el);
      setTimeout(() => el.remove(), 1000);
    }

    function trackEvent(eventName, params = {}){
      try {
        if (window.gtag){
          gtag('event', eventName, params);
        }
      } catch(e){
        console.warn('Analytics tracking failed:', e);
      }
    }

    // Wix auto-height: postMessage -> Velo changes iframe height
    function postHeightToWix(){
      try{
        const h = Math.max(
          document.documentElement.scrollHeight || 0,
          document.body.scrollHeight || 0
        );
        window.parent?.postMessage({ type: 'PPF_FORM_HEIGHT', h }, '*');
      } catch(e){}
    }

    // ---------- UI from ui_form_fields ----------
    const ui = { map: new Map(), ready: false };

    function parseMeta(m){
      if (!m) return {};
      if (typeof m === 'object') return m;
      if (typeof m === 'string'){
        try { return JSON.parse(m); } catch(e){ return {}; }
      }
      return {};
    }

    function uiRow(key){ return ui.map.get(String(key)) || null; }
    function uiLabel(key, fallback=''){
      const r = uiRow(key);
      const v = (r?.label_es ?? r?.label);
      return (v != null && String(v).trim() !== '') ? String(v) : fallback;
    }
    function uiMeta(key){
      const r = uiRow(key);
      return parseMeta(r?.meta);
    }
    function uiEnabled(key, fallback=true){
      const r = uiRow(key);
      if (!r) return fallback;
      return r.enabled !== false;
    }
    function uiRequired(key, fallback=false){
      const r = uiRow(key);
      if (!r) return fallback;
      return r.required === true;
    }

    function stripStar(s){ return String(s||'').replace(/\*/g,'').trim(); }
    function setStar(starId, required){
      const el = byId(starId);
      if (!el) return;
      el.style.display = required ? '' : 'none';
    }
    function setText(id, text){
      const el = byId(id);
      if (!el) return;
      el.textContent = String(text ?? '');
    }
    function setHTML(id, html){
      const el = byId(id);
      if (!el) return;
      el.innerHTML = String(html ?? '');
    }

    function placeholderText(key, fallback){
      const t = uiLabel(key, '');
      return (t && t.trim()) ? t.trim() : fallback;
    }

    // ----------------- LOAD: brands/models/years -----------------
    async function loadBrands(){
      const el = byId('brand');
      el.disabled = true;
      el.innerHTML = '<option value="">Cargando marcas...</option>';
      try{
        // Note: car brands are global, not form-scoped
        const { data } = await sb.from('v_catalog_brands')
          .select('brand')
          .order('brand', { ascending:true })
          .throwOnError();

        const brands = [...new Set((data||[]).map(r=>r.brand).filter(Boolean))];
        const ph = placeholderText('brand_placeholder', 'Selecciona una marca');

        el.innerHTML =
          `<option value="" disabled selected>${escapeHtml(ph)}</option>` +
          brands.map(b=>`<option value="${escapeHtml(b)}">${escapeHtml(b)}</option>`).join('');
      } catch(e){
        console.error('loadBrands:', e);
        el.innerHTML = '<option value="">Error al cargar marcas.</option>';
      } finally {
        el.disabled = false;
      }
    }

    async function loadModels(brand){
      const el = byId('model');
      el.disabled = true;

      if (!brand){
        const ph = placeholderText('model_placeholder', 'Selecciona un modelo');
        el.innerHTML = `<option value="" disabled selected>${escapeHtml(ph)}</option>`;
        el.disabled = true;
        return;
      }

      el.innerHTML = '<option value="">Cargando modelos...</option>';

      try{
        const { data } = await sb.from('v_catalog_models')
          .select('model')
          .eq('brand', brand)
          .order('model', { ascending:true })
          .throwOnError();

        const models = [...new Set((data||[]).map(r=>r.model).filter(Boolean))];
        const ph = placeholderText('model_placeholder', 'Selecciona un modelo');

        el.innerHTML =
          `<option value="" disabled selected>${escapeHtml(ph)}</option>` +
          models.map(m=>`<option value="${escapeHtml(m)}">${escapeHtml(m)}</option>`).join('');
      } catch(e){
        console.error('loadModels:', e);
        el.innerHTML = '<option value="">Error al cargar modelos.</option>';
      } finally {
        el.disabled = false;
      }
    }

    async function loadYears(){
      const el = byId('year');
      el.disabled = true;
      el.innerHTML = '<option value="">Cargando a√±os...</option>';
      try{
        const { data } = await sb.from('v_catalog_years')
          .select('year')
          .order('year', { ascending:false })
          .throwOnError();

        const years = [...new Set((data||[]).map(r=>String(r.year)).filter(Boolean))];
        const ph = placeholderText('year_placeholder', 'Selecciona un a√±o');

        el.innerHTML =
          `<option value="" disabled selected>${escapeHtml(ph)}</option>` +
          years.map(y=>`<option value="${escapeHtml(y)}">${escapeHtml(y)}</option>`).join('');
      } catch(e){
        console.error('loadYears:', e);
        el.innerHTML = '<option value="">Error al cargar a√±os.</option>';
      } finally {
        el.disabled = false;
      }
    }

    // ----------------- LOAD: install_centers -----------------
    async function loadInstallCenters(){
      const el = byId('install_center');
      el.disabled = true;
      el.innerHTML = '<option value="">Cargando centros...</option>';
      try{
        // Prefer VIEW: already filtered (enabled=true) + safe columns
        const { data } = await sb
          .from('v_catalog_install_centers')
          .select('center_key,title_es,city')
          .order('sort_order', { ascending:true })
          .throwOnError();

        const rows = (data||[]).filter(r => r && r.center_key && r.title_es);

        const ph = placeholderText('center_placeholder', 'Selecciona una opci√≥n');
        el.innerHTML =
          `<option value="">${escapeHtml(ph)}</option>` +
          rows.map(r => {
            const label = r.city ? `${r.title_es} (${r.city})` : r.title_es;
            return `<option value="${escapeHtml(String(r.center_key))}">${escapeHtml(String(label))}</option>`;
          }).join('');

        appData.centers = new Map(rows.map(r => [String(r.center_key), r]));
      } catch(e){
        console.error('loadInstallCenters:', e);
        el.innerHTML = '<option value="">Error al cargar centros.</option>';
      } finally {
        el.disabled = false;
      }
    }

    // ----------------- LOAD: Finishes -----------------
    async function loadFinishes(){
      const finishSel = byId('finish');
      const finishSelParts = byId('finish_parts');
      finishSel.innerHTML = '<option value="">Cargando opciones...</option>';
      finishSelParts.innerHTML = '<option value="">Cargando opciones...</option>';

      try{
        const { data } = await sb.from('v_catalog_finishes')
          .select('finish_key,title_es,allow_partial,warning_partial,sort_order,form_key')
          .eq('form_key', FORM_KEY)
          .order('sort_order', { ascending:true })
          .throwOnError();

        // IMPORTANT: some schemas use title_es, others use title. We normalize to .title
        const rows = (data || [])
          .map(r => ({
            ...r,
            title: String((r && (r.title_es || r.title)) || '').trim()
          }))
          .filter(r => r.finish_key && r.title);

        const placeholder = placeholderText('finish_placeholder', 'Selecciona una opci√≥n');

        const options =
          `<option value="" disabled selected>${escapeHtml(placeholder)}</option>` +
          rows.map(r => `<option value="${escapeHtml(String(r.finish_key))}">${escapeHtml(String(r.title))}</option>`).join('');

        finishSel.innerHTML = options;
        finishSelParts.innerHTML = options;

        appData.finishes = new Map(rows.map(r => [String(r.finish_key), r]));
      } catch(e){
        console.error('loadFinishes:', e);
        finishSel.innerHTML = '<option value="">Error al cargar opciones.</option>';
        finishSelParts.innerHTML = '<option value="">Error al cargar opciones.</option>';
      }
    }


    // ----------------- LOAD: Film Brands (PPF vendor) -----------------
    async function loadFilmBrands(){
      const elA = byId('film_brand');
      const elB = byId('film_brand_parts');

      // Allow missing elements (safe)
      if (elA) { elA.disabled = true; elA.innerHTML = '<option value="">Cargando marcas...</option>'; }
      if (elB) { elB.disabled = true; elB.innerHTML = '<option value="">Cargando marcas...</option>'; }

      try{
        const { data } = await sb
          .from('v_catalog_film_brands')
          .select('form_key,film_brand,title_es,sort_order')
          .eq('form_key', FORM_KEY)
          .order('sort_order', { ascending:true })
          .throwOnError();

        const rows = (data || []).filter(r => r && r.film_brand && (r.title_es || r.title));

        const ph = placeholderText('film_brand_placeholder', '‚Äî No especificado ‚Äî');

        const options =
          `<option value="">${escapeHtml(ph)}</option>` +
          rows.map(r => `<option value="${escapeHtml(String(r.film_brand))}">${escapeHtml(String(r.title_es || r.title))}</option>`).join('');

        if (elA) elA.innerHTML = options;
        if (elB) elB.innerHTML = options;

        appData.filmBrands = new Map(rows.map(r => [String(r.film_brand), r]));
      } catch(e){
        console.error('loadFilmBrands:', e);
        if (elA) elA.innerHTML = '<option value="">Error al cargar marcas.</option>';
        if (elB) elB.innerHTML = '<option value="">Error al cargar marcas.</option>';
      } finally {
        if (elA) elA.disabled = false;
        if (elB) elB.disabled = false;
      }
    }

    function setFilmBrand(val){
      const v = String(val || '').trim();
      state.film_brand = v ? v : null;
    }

    function syncFilmBrand(from){
      const a = byId('film_brand');
      const b = byId('film_brand_parts');
      if (!a || !b) return;

      if (from === 'a') b.value = a.value;
      if (from === 'b') a.value = b.value;

      setFilmBrand(from === 'a' ? a.value : b.value);
    }

    function applyFilmBrandVisibility(){
      const enabled = uiEnabled('film_brand', true);

      const w1 = byId('wrap-film-brand');
      const w2 = byId('wrap-film-brand-parts');

      if (w1) w1.style.display = enabled ? '' : 'none';
      if (w2) w2.style.display = enabled ? '' : 'none';

      if (!enabled){
        setFilmBrand(null);
        const a = byId('film_brand'); if (a) a.value = '';
        const b = byId('film_brand_parts'); if (b) b.value = '';
      }

      // labels (even if uiLabel falls back)
      setText('lbl-film-brand', stripStar(uiLabel('film_brand', byId('lbl-film-brand')?.textContent || 'Marca de la pel√≠cula (opcional)')));
      setText('lbl-film-brand-parts', stripStar(uiLabel('film_brand', byId('lbl-film-brand-parts')?.textContent || 'Marca de la pel√≠cula (opcional)')));
    }

    // ----------------- LOAD: catalog_services (replaces price_ui + price join) -----------------
    async function loadPriceUI(){
      try{
        const { data } = await sb.from('v_catalog_services')
          .select('service_key,title_es,service_type,sort_order,ui_step,ui_block,ui_group,ui_tab')
          .order('sort_order', { ascending:true })
          .throwOnError();

        const rows = (data||[]).filter(r=>r.service_key && r.title_es);

        const packages = rows
          .filter(r => r.ui_step === 3 && r.ui_block === 'paquetes' && r.service_type === 'basic')
          .map(r => ({ price_id: String(r.service_key), name: String(r.title_es), sort_order: r.sort_order }));

        renderPackages(packages);

        const parts = rows
          .filter(r => r.ui_step === 3 && r.ui_block === 'partes' && r.service_type === 'partial')
          .map(r => ({ price_id: String(r.service_key), name: String(r.title_es), group: r.ui_group, sort_order: r.sort_order }));

        const partsCatalog = { frontal: [], lateral: [], trasera: [] };
        for (const p of parts){
          const g = (p.group || '').toLowerCase();
          if (g === 'front') partsCatalog.frontal.push(p);
          else if (g === 'side') partsCatalog.lateral.push(p);
          else if (g === 'rear') partsCatalog.trasera.push(p);
        }
        appData.partsCatalog = partsCatalog;

        const extras = rows
          .filter(r => r.ui_step === 4 && r.ui_block === 'extras' && r.service_type === 'partial')
          .map(r => ({ price_id: String(r.service_key), name: String(r.title_es), sort_order: r.sort_order }));

        const servicios = rows
          .filter(r => r.ui_step === 4 && r.ui_block === 'servicios' && r.service_type === 'partial')
          .map(r => ({ price_id: String(r.service_key), name: String(r.title_es), sort_order: r.sort_order }));

        appData.extrasList = extras;
        appData.serviciosList = servicios;

        renderParts(partsCatalog);
        renderExtras(extras);
        renderServicios(servicios);

        postHeightToWix();
      } catch(e){
        console.error('loadPriceUI:', e);
      }
    }

    // ----------------- RENDER -----------------
    function renderPackages(packages){
      const box = byId('packages-buttons');
      if (!box) return;

      const sorted = [...packages].sort((a,b)=>(a.sort_order||0)-(b.sort_order||0));
      box.innerHTML = sorted.map(p => `
        <button type="button" class="pkg" data-pkg="${escapeHtml(p.price_id)}">
          <div class="text-lg font-black">${escapeHtml(p.name)}</div>
          <div class="text-sm text-slate-300 mt-1">Paquete recomendado</div>
        </button>
      `).join('');

      box.querySelectorAll('[data-pkg]').forEach(btn => {
        btn.addEventListener('click', () => {
          const id = btn.getAttribute('data-pkg');
          state.selectedPackage = id || '';
          box.querySelectorAll('[data-pkg]').forEach(b => b.classList.toggle('active', b === btn));
          byId('step3-hint').textContent = '';
          postHeightToWix();
        });
      });
    }

    function renderParts(cat){
      const list = byId('parts-list');
      if (!list) return;

      const mkRow = (p) => `
        <label class="check-row">
          <input type="checkbox" data-part="${escapeHtml(p.price_id)}" />
          <div>
            <div class="name">${escapeHtml(p.name)}</div>
          </div>
        </label>
      `;

      const renderZone = (zone) => {
        const arr = (cat[zone] || []).slice().sort((a,b)=>(a.sort_order||0)-(b.sort_order||0));
        list.innerHTML = arr.map(mkRow).join('');

        list.querySelectorAll('[data-part]').forEach(cb => {
          cb.checked = state.selectedParts.has(cb.getAttribute('data-part'));
          cb.addEventListener('change', () => {
            const id = cb.getAttribute('data-part');
            if (!id) return;
            if (cb.checked) state.selectedParts.add(id);
            else state.selectedParts.delete(id);
            updatePartsCount();
          });
        });

        updatePartsCount();
        postHeightToWix();
      };

      // tabs
      const tabFr = byId('tab-frontal');
      const tabLa = byId('tab-lateral');
      const tabTr = byId('tab-trasera');

      const setTab = (zone) => {
        tabFr.classList.toggle('active', zone === 'frontal');
        tabLa.classList.toggle('active', zone === 'lateral');
        tabTr.classList.toggle('active', zone === 'trasera');

        tabFr.setAttribute('aria-selected', zone === 'frontal' ? 'true':'false');
        tabLa.setAttribute('aria-selected', zone === 'lateral' ? 'true':'false');
        tabTr.setAttribute('aria-selected', zone === 'trasera' ? 'true':'false');

        renderZone(zone);
      };

      tabFr.addEventListener('click', ()=> setTab('frontal'));
      tabLa.addEventListener('click', ()=> setTab('lateral'));
      tabTr.addEventListener('click', ()=> setTab('trasera'));

      setTab('frontal');
    }

    function renderExtras(extras){
      const list = byId('extras-list');
      if (!list) return;

      const sorted = [...extras].sort((a,b)=>(a.sort_order||0)-(b.sort_order||0));
      list.innerHTML = sorted.map(x => `
        <label class="check-row">
          <input type="checkbox" data-extra="${escapeHtml(x.price_id)}" />
          <div>
            <div class="name">${escapeHtml(x.name)}</div>
          </div>
        </label>
      `).join('');

      list.querySelectorAll('[data-extra]').forEach(cb => {
        cb.checked = state.selectedExtras.has(cb.getAttribute('data-extra'));
        cb.addEventListener('change', () => {
          const id = cb.getAttribute('data-extra');
          if (!id) return;
          if (cb.checked) state.selectedExtras.add(id);
          else state.selectedExtras.delete(id);
          updateExtrasCount();
        });
      });

      updateExtrasCount();
      postHeightToWix();
    }

    function renderServicios(servs){
      const list = byId('services-list');
      if (!list) return;

      const sorted = [...servs].sort((a,b)=>(a.sort_order||0)-(b.sort_order||0));
      list.innerHTML = sorted.map(x => `
        <label class="check-row">
          <input type="checkbox" data-serv="${escapeHtml(x.price_id)}" />
          <div>
            <div class="name">${escapeHtml(x.name)}</div>
          </div>
        </label>
      `).join('');

      list.querySelectorAll('[data-serv]').forEach(cb => {
        cb.checked = state.selectedServicios.has(cb.getAttribute('data-serv'));
        cb.addEventListener('change', () => {
          const id = cb.getAttribute('data-serv');
          if (!id) return;
          if (cb.checked) state.selectedServicios.add(id);
          else state.selectedServicios.delete(id);
          updateExtrasCount();
        });
      });

      updateExtrasCount();
      postHeightToWix();
    }

    function updatePartsCount(){
      const count = state.selectedParts.size;
      const el = byId('ui-subtitle');
      const msg = count ? `${count} seleccionado(s)` : 'Selecciona las partes que quieres proteger.';
      if (el) el.textContent = msg;
      postHeightToWix();
    }

    function updateExtrasCount(){
      const count = state.selectedExtras.size + state.selectedServicios.size;
      const el = byId('step4-count');
      if (el) el.textContent = count ? `${count} seleccionado(s)` : 'Ninguno seleccionado';
      postHeightToWix();
    }

    // ----------------- STATE -----------------
    const appData = {
      centers: new Map(),
      finishes: new Map(),
      filmBrands: new Map(),
      partsCatalog: { frontal: [], lateral: [], trasera: [] },
      extrasList: [],
      serviciosList: []
    };

    const state = {
      step: 1,
      prevStep: null,
      flow: "",

      brand: "",
      model: "",
      year: "",

      install_center_id: "",
      install_center_title: "",

      film_brand: null,

      finish_key: "",
      finish_title: "",
      finish_allow_partial: true,
      finish_warning_partial: "",

      selectedPackage: "",
      selectedParts: new Set(),
      selectedExtras: new Set(),
      selectedServicios: new Set(),

      send_channel: "email",

      step4BackTarget: 3,
      startedAt: Date.now(),

      submitting: false,
      lastSubmitAt: 0
    };

    // ----------------- STEP CONTROL -----------------
    function stepLabelText(step){
      const tpl = uiLabel('step_label_template', 'Paso {step} de 5');
      return String(tpl).replace('{step}', String(step));
    }

    function scrollToFormTop(){
      const top = byId('form-top');
      if (top) top.scrollIntoView({ behavior: 'smooth', block: 'start' });
      else window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function setDots(step){
      dots.forEach((d,i)=> d.classList.toggle('active', i === (step-1)));
    }

    function showStep(step){
      state.prevStep = state.step;
      state.step = step;

      steps.forEach((s,i)=> s.classList.toggle('hidden', (i+1) !== step));
      stepLabelEl.textContent = stepLabelText(step);
      setDots(step);

      // step title focus for screen readers
      const h = steps[step-1]?.querySelector('[tabindex="-1"]');
      if (h) h.focus({ preventScroll:true });

      trackEvent('form_step_viewed', { step });
      announceToScreenReader(`Paso ${step}`);

      postHeightToWix();
      scrollToFormTop();
    }

    // ----------------- Inline validation -----------------
    function emailValid(v){
      const s = String(v||'').trim().toLowerCase();
      const re = /^[a-z0-9._-]+@[a-z0-9.-]+\.[a-z]{2,}$/i;
      if (s.includes('..')) return false;
      return re.test(s);
    }

    function markField(el, ok){
      if (!el) return;
      el.classList.toggle('invalid', !ok);
      el.classList.toggle('valid', ok);
    }
    function clearFieldMark(el){
      if (!el) return;
      el.classList.remove('invalid','valid');
    }
    function setFieldHint(id, text){
      const el = byId(id);
      if (!el) return;
      if (!text){
        el.classList.add('hidden');
        el.textContent = '';
      } else {
        el.classList.remove('hidden');
        el.textContent = text;
      }
      postHeightToWix();
    }

    function validateName(){
      const el = byId('name_client');
      const v = (el.value||'').trim();
      const ok = v.length >= 2;
      markField(el, ok);
      setFieldHint('name-hint', ok ? '' : 'Escribe tu nombre (m√≠nimo 2 caracteres).');
      return ok;
    }

    function basicPhoneFallbackOk(raw){
      const s = String(raw||'').trim();
      if (!s) return false;
      const digits = s.replace(/[^\d]/g,'');
      if (digits.length < 8 || digits.length > 16) return false;
      return true;
    }

    function validatePhone(){
      const el = byId('phone');
      const raw = (el.value||'').trim();

      if (!raw){
        markField(el, false);
        setFieldHint('phone-hint', 'Introduce tu tel√©fono.');
        return false;
      }

      // intl-tel-input not initialized -> fallback mode
      if (!iti){
        const ok = basicPhoneFallbackOk(raw);
        markField(el, ok);
        setFieldHint('phone-hint', ok ? '' : 'Tel√©fono inv√°lido. Revisa el n√∫mero.');
        return ok;
      }

      // utils still not ready -> fallback mode
      if (!window.intlTelInputUtils){
        const ok = basicPhoneFallbackOk(raw);
        markField(el, ok);
        setFieldHint('phone-hint', ok ? '' : 'Tel√©fono inv√°lido. Revisa el prefijo y el n√∫mero.');
        return ok;
      }

      const ok = iti.isValidNumber();
      markField(el, ok);

      if (!ok){
        const msg = uiLabel('phone_invalid_message', 'Tel√©fono inv√°lido. Revisa el prefijo y el n√∫mero.');
        setFieldHint('phone-hint', msg);
        return false;
      }

      setFieldHint('phone-hint', '');
      return true;
    }

    function validateEmail(){
      const el = byId('email_client');
      const v = (el.value||'').trim();
      const ok = emailValid(v);
      markField(el, ok);
      setFieldHint('email-hint', ok ? '' : 'Email inv√°lido.');
      return ok;
    }

    function validateConsent(){
      const checked = byId('consent')?.checked;
      if (!checked){
        setFieldHint('consent-hint', 'Debes aceptar la pol√≠tica de privacidad para continuar.');
        return false;
      }
      setFieldHint('consent-hint', '');
      return true;
    }

    function step5Valid(){
      return validateName() && validatePhone() && validateEmail() && validateConsent();
    }

    function step1MissingFields(){
      const missing = [];
      const brandRequired = uiRequired('brand', true);
      const modelRequired = uiRequired('model', true);
      const yearRequired  = uiRequired('year', true);
      const centerRequired = uiRequired('center', true);

      const brand = byId('brand')?.value || '';
      const model = byId('model')?.value || '';
      const year  = byId('year')?.value || '';
      const center = byId('install_center')?.value || '';

      if (brandRequired && !brand) missing.push('Marca');
      if (modelRequired && !model) missing.push('Modelo');
      if (yearRequired && !year) missing.push('A√±o');
      if (centerRequired && uiEnabled('center', true) && !center) missing.push('Centro');

      return missing;
    }

    function step2Valid(){
      return state.flow === 'total' || state.flow === 'parts';
    }

    function step3Valid(){
      if (state.flow === 'total'){
        if (!state.selectedPackage) return false;
        if (!state.finish_key) return false;
        return true;
      }
      if (state.flow === 'parts'){
        if (!state.selectedParts.size) return false;
        if (!state.finish_key) return false;
        return true;
      }
      return false;
    }

    // ----------------- Finish sync (3A <-> 3B) -----------------
    function applyFinishToState(key){
      const row = appData.finishes.get(String(key));
      state.finish_key = key || '';
      state.finish_title = row ? String(row.title || row.title_es || '') : '';
      state.finish_allow_partial = row ? (row.allow_partial !== false) : true;
      state.finish_warning_partial = row ? String(row.warning_partial || '') : '';
    }

    function syncFinish(from){
      const a = byId('finish');
      const b = byId('finish_parts');
      if (!a || !b) return;

      if (from === 'finish') b.value = a.value;
      if (from === 'finish_parts') a.value = b.value;

      applyFinishToState(from === 'finish' ? a.value : b.value);
      applyFinishWarnings();
      postHeightToWix();
    }

    function applyFinishWarnings(){
      const allowPartial = state.finish_allow_partial !== false;
      const warnText = (state.finish_warning_partial || '').trim();

      // pack warning
      const boxA = byId('pack-warning-box');
      const bodyA = byId('pack-warning-body');
      if (boxA && bodyA){
        if (warnText){
          boxA.classList.remove('hidden');
          bodyA.textContent = warnText;
        } else {
          boxA.classList.add('hidden');
          bodyA.textContent = '';
        }
      }

      // parts warning + partial blocking
      const boxB = byId('parts-warning-box');
      const bodyB = byId('parts-warning-body');
      if (boxB && bodyB){
        if (warnText){
          boxB.classList.remove('hidden');
          bodyB.textContent = warnText;
        } else {
          boxB.classList.add('hidden');
          bodyB.textContent = '';
        }
      }

      // if finish forbids partial, force flow total
      if (state.flow === 'parts' && !allowPartial){
        byId('step3-hint').textContent = warnText || 'Este tipo de cobertura no permite instalaci√≥n parcial.';
        // auto switch to total
        state.flow = 'total';
        state.selectedParts.clear();
        byId('choose-total')?.classList.add('active');
        byId('choose-parts')?.classList.remove('active');
        showStep(3);
        updatePartsCount();
      }
    }

    function updateStep1UI(){
      const brand = byId('brand')?.value || '';
      const model = byId('model')?.value || '';
      const year  = byId('year')?.value || '';
      const center = byId('install_center')?.value || '';

      state.brand = brand;
      state.model = model;
      state.year = year;

      const c = appData.centers.get(String(center));
      state.install_center_id = center || '';
      state.install_center_title = c ? String(c.title_es || '') : '';

      postHeightToWix();
    }

    // ----------------- UI APPLY -----------------
    function applyUI(){
      setText('hero-title', uiLabel('hero_title', byId('hero-title')?.textContent || ''));
      setText('hero-subtitle', uiLabel('hero_subtitle', byId('hero-subtitle')?.textContent || ''));

      setText('step1-title', uiLabel('step1_title', byId('step1-title')?.textContent || ''));
      setText('step2-title', uiLabel('step2_title', byId('step2-title')?.textContent || ''));
      setText('step4-title', uiLabel('step4_title', byId('step4-title')?.textContent || ''));
      setText('step5-title', uiLabel('step5_title', byId('step5-title')?.textContent || ''));

      setText('lbl-brand', stripStar(uiLabel('brand', 'Marca')));
      setText('lbl-model', stripStar(uiLabel('model', 'Modelo')));
      setText('lbl-year',  stripStar(uiLabel('year', 'A√±o')));
      setStar('star-brand', uiRequired('brand', true));
      setStar('star-model', uiRequired('model', true));
      setStar('star-year',  uiRequired('year', true));

      // center visibility + label
      const centerEnabled = uiEnabled('center', true);
      const centerWrap = byId('wrap-center');
      if (centerWrap) centerWrap.style.display = centerEnabled ? '' : 'none';
      setText('lbl-center', stripStar(uiLabel('center', byId('lbl-center')?.textContent || 'Centro')));
      setStar('star-center', uiRequired('center', true));

      // comment label
      setText('lbl-comment', stripStar(uiLabel('comment', byId('lbl-comment')?.textContent || 'Comentario')));

      // step buttons
      setText('next-1', uiLabel('next_1', byId('next-1')?.textContent || 'Continuar'));
      setText('back-2', uiLabel('back_2', byId('back-2')?.textContent || 'Atr√°s'));
      setText('next-2', uiLabel('next_2', byId('next-2')?.textContent || 'Continuar'));
      setText('back-3', uiLabel('back_3', byId('back-3')?.textContent || 'Atr√°s'));
      setText('next-3', uiLabel('next_3', byId('next-3')?.textContent || 'Continuar'));
      setText('back-4', uiLabel('back_4', byId('back-4')?.textContent || 'Atr√°s'));
      setText('next-4', uiLabel('next_4', byId('next-4')?.textContent || 'Continuar'));
      setText('back-5', uiLabel('btn_back_5', byId('back-5')?.textContent || 'Atr√°s'));
      setText('submit-text', uiLabel('btn_submit', byId('submit-text')?.textContent || 'Enviar presupuesto'));

      // step label template
      stepLabelEl.textContent = stepLabelText(state.step);

      // service step 2 cards
      setText('choose-total-title', uiLabel('service_total_title', byId('choose-total-title')?.textContent || 'Cobertura total'));
      setText('choose-total-desc', uiLabel('service_total_desc', byId('choose-total-desc')?.textContent || 'Paquetes recomendados'));
      setText('choose-parts-title', uiLabel('service_parts_title', byId('choose-parts-title')?.textContent || 'Cobertura parcial'));
      setText('choose-parts-desc', uiLabel('service_parts_desc', byId('choose-parts-desc')?.textContent || 'Selecciona partes'));

      // packages + finishes labels
      setText('packages-title', uiLabel('packages_title', byId('packages-title')?.textContent || 'Elige un paquete'));
      const def = uiMeta('packages_title').default_text || byId('packages-desc')?.textContent || '';
      setText('packages-desc', def);

      setText('finish-title-pack', uiLabel('finish', byId('finish-title-pack')?.textContent || 'Tipo de cobertura'));
      setText('finish-title-parts', uiLabel('finish', byId('finish-title-parts')?.textContent || 'Tipo de cobertura'));

      // Film brand (optional)
      applyFilmBrandVisibility();

      const partsLabel = uiLabel('parts_block_title', 'Selecci√≥n de partes (Carrocer√≠a)');
      setHTML('ui-title', DOMPurify.sanitize(partsLabel));

      // step 4 labels
      setText('extras-title', uiLabel('extras_title', byId('extras-title')?.textContent || 'Extras'));
      setText('services-title', uiLabel('services_title', byId('services-title')?.textContent || 'Servicios adicionales'));
      setText('promo-label', uiLabel('promo_label', byId('promo-label')?.textContent || 'Tengo promoci√≥n / c√≥digo'));

      // step 5 labels
      setText('lbl-name', stripStar(uiLabel('name', byId('lbl-name')?.textContent || 'Nombre')));
      setText('lbl-phone', stripStar(uiLabel('phone', byId('lbl-phone')?.textContent || 'Tel√©fono')));
      setText('lbl-email', stripStar(uiLabel('email', byId('lbl-email')?.textContent || 'Email')));

      setText('send-title', uiLabel('send_title', byId('send-title')?.textContent || '¬øC√≥mo prefieres recibir el presupuesto?'));
      setText('send-desc', uiLabel('send_desc', byId('send-desc')?.textContent || 'Te enviaremos el presupuesto por el canal elegido.'));

      const waLabel = uiLabel('cta_whatsapp', 'WhatsApp');
      const emLabel = uiLabel('cta_email', 'Email');

      const waCore = String(waLabel).replace(/^enviar\s+por\s+/i,'').trim() || 'WhatsApp';
      const emCore = String(emLabel).replace(/^enviar\s+por\s+/i,'').trim() || 'Email';

      setText('send-tab-wa', `üì± ${waCore}`);
      setText('send-tab-email', `üìß ${emCore}`);

      const p = uiMeta('privacy_text');
      if (p && (p.text || p.url || p.link_text)){
        const url = p.url || PRIVACY_URL;
        const linkText = p.link_text || 'Pol√≠tica de privacidad';
        const fullText = p.text || '';

        const idx = fullText.indexOf(linkText);
        const before = idx >= 0 ? fullText.slice(0, idx) : fullText;
        const after = idx >= 0 ? fullText.slice(idx + linkText.length) : '';

        const strongPhrase = 'He le√≠do y acepto';
        const beforeEsc = escapeHtml(before);
        const afterEsc = escapeHtml(after);

        const beforeHtml = beforeEsc.replace(
          escapeHtml(strongPhrase),
          `<strong>${escapeHtml(strongPhrase)}</strong>`
        );

        const a = `<a href="${escapeHtml(url)}" target="_blank" rel="noopener noreferrer" class="underline">${escapeHtml(linkText)}</a>`;
        const html = `${beforeHtml}${a}${afterEsc}`.trim();
        if (html) setHTML('privacy-text', html);
      }

      ui.ready = true;
    }

    async function loadUIFields(){
      try{
        const { data } = await sb
          .from('v_catalog_ui_form_fields')
          .select('field_key,step,label_es,enabled,required,sort_order,meta')
          .order('sort_order', { ascending: true })
          .throwOnError();

        ui.map.clear();
        (data || []).forEach(r => {
          if (r && r.field_key) ui.map.set(String(r.field_key), r);
        });

        applyUI();
      } catch(e){
        console.warn('ui_form_fields load failed:', e);
      }
    }

    // ----------------- FALLBACK QUEUE (localStorage) -----------------
    const PENDING_KEY = `${FORM_KEY}_pending_queue_v1`;

    function readPending(){
      try{
        const raw = localStorage.getItem(PENDING_KEY);
        const arr = raw ? JSON.parse(raw) : [];
        return Array.isArray(arr) ? arr : [];
      } catch(e){
        return [];
      }
    }

    function writePending(arr){
      try{
        localStorage.setItem(PENDING_KEY, JSON.stringify(arr || []));
      } catch(e){}
    }

    function enqueuePending(payload){
      const arr = readPending();
      arr.push({ ts: Date.now(), payload });
      writePending(arr);
    }

    async function flushPending(){
      const arr = readPending();
      if (!arr.length) return;

      const keep = [];
      for (let i = 0; i < arr.length; i++){
        const item = arr[i];
        try{
          await postToWebhook(item.payload, { silent: true });
        } catch(e){
          keep.push(item, ...arr.slice(i + 1));
          break;
        }
      }
      writePending(keep);
    }

    // ----------------- Phone helpers -----------------
    function initPhone(){
      const input = byId('phone');
      if (!input) return;

      try{
        iti = window.intlTelInput(input, {
          initialCountry: 'es',
          separateDialCode: true,
          autoPlaceholder: 'polite',
          utilsScript: 'https://cdn.jsdelivr.net/npm/intl-tel-input@23.8.0/build/js/utils.js'
        });
      } catch(e){
        console.warn('intl-tel-input init failed:', e);
        iti = null;
      }
    }

    function getPhoneE164(){
      const el = byId('phone');
      const raw = (el?.value || '').trim();
      if (!raw) return '';

      try{
        if (iti && iti.getNumber) return iti.getNumber() || raw;
      } catch(e){}
      return raw;
    }

    function getPhoneCountry(){
      try{
        if (iti && iti.getSelectedCountryData){
          return iti.getSelectedCountryData()?.iso2 || '';
        }
      } catch(e){}
      return '';
    }

    // ----------------- Reset after success -----------------
    function resetFormAfterSuccess(){
      setMsg('');
      byId('step1-hint').textContent = '';
      byId('step2-hint').textContent = '';
      byId('step3-hint').textContent = '';
      byId('step4-hint').textContent = '';
      setFieldHint('name-hint','');
      setFieldHint('phone-hint','');
      setFieldHint('email-hint','');
      setFieldHint('consent-hint','');

      clearFieldMark(byId('name_client'));
      clearFieldMark(byId('phone'));
      clearFieldMark(byId('email_client'));

      byId('name_client').value = '';
      byId('email_client').value = '';
      byId('comment').value = '';
      byId('promo').checked = false;
      byId('consent').checked = false;

      if (iti){
        byId('phone').value = '';
        try { iti.setNumber(''); } catch(e){}
      } else {
        byId('phone').value = '';
      }

      state.flow = '';
      state.brand = '';
      state.model = '';
      state.year = '';
      state.install_center_id = '';
      state.install_center_title = '';
      state.film_brand = null;
      state.finish_key = '';
      state.finish_title = '';
      state.finish_allow_partial = true;
      state.finish_warning_partial = '';
      state.selectedPackage = '';
      state.selectedParts.clear();
      state.selectedExtras.clear();
      state.selectedServicios.clear();
      state.send_channel = 'email';

      // reset selects/inputs
      byId('brand').value = '';
      byId('model').value = '';
      byId('year').value = '';
      byId('install_center').value = '';

      byId('finish').value = '';
      byId('finish_parts').value = '';
      byId('film_brand').value = '';
      byId('film_brand_parts').value = '';

      // clear packages UI
      byId('packages-buttons')?.querySelectorAll('[data-pkg]')?.forEach(b => b.classList.remove('active'));

      // clear parts UI
      byId('parts-list')?.querySelectorAll('input[type="checkbox"]')?.forEach(cb => cb.checked = false);

      // clear extras/services UI
      byId('extras-list')?.querySelectorAll('input[type="checkbox"]')?.forEach(cb => cb.checked = false);
      byId('services-list')?.querySelectorAll('input[type="checkbox"]')?.forEach(cb => cb.checked = false);

      // flow cards
      byId('choose-total')?.classList.remove('active');
      byId('choose-parts')?.classList.remove('active');

      showStep(1);
    }

    // ----------------- Payload -----------------
    function collectPayload(){
      const cat = appData.partsCatalog;
      const allParts = [...cat.frontal, ...cat.lateral, ...cat.trasera];

      const idToName = new Map(allParts.map(x=>[String(x.price_id), x.name]));
      const extrasNames = (appData.extrasList||[]).reduce((m,x)=> (m.set(String(x.price_id), x.name), m), new Map());
      const servNames   = (appData.serviciosList||[]).reduce((m,x)=> (m.set(String(x.price_id), x.name), m), new Map());

      const selectedPartsNames = [...state.selectedParts].map(id=>idToName.get(String(id))).filter(Boolean);
      const selectedExtrasNames = [...state.selectedExtras].map(id=>extrasNames.get(String(id))).filter(Boolean);
      const selectedServiciosNames = [...state.selectedServicios].map(id=>servNames.get(String(id))).filter(Boolean);

      const servicePartialAll = [...selectedPartsNames, ...selectedExtrasNames, ...selectedServiciosNames];

      const consentAt = new Date().toISOString();

      const phoneE164 = getPhoneE164();
      const phoneCountry = getPhoneCountry();

      return {
        name_client: (byId('name_client')?.value || '').trim(),
        email_client: (byId('email_client')?.value || '').trim(),

        phone: phoneE164,
        phone_country: phoneCountry,

        marca: state.brand || byId('brand').value || '',
        modelo: state.model || byId('model').value || '',
        a√±o: state.year || byId('year').value || '',

        install_center_id: state.install_center_id,
        install_center: state.install_center_title,

        service_basic: state.flow === 'total' ? (state.selectedPackage || '') : '',
        service_partial: servicePartialAll.join(', '),

        film_brand: state.film_brand,
        finish_key: state.finish_key,
        finish_title: state.finish_title,

        flow: state.flow,
        check_promotion: byId('promo')?.checked ? 'Checked' : '',

        comment: (byId('comment')?.value || '').trim(),

        mode: 'text',
        send_channel: state.send_channel,

        consent_at: consentAt,
        consent_policy_url: PRIVACY_URL,

        privacy_policy_accepted: !!byId('consent')?.checked
      };
    }

    // ----------------- Webhook POST -----------------
    async function postToWebhook(payload, { silent = false } = {}){
      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), 15000);

      try{
        const res = await fetch(WEBHOOK_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
          signal: controller.signal
        });

        const data = await res.json().catch(()=> ({}));

        if (!res.ok){
          const errMsg = data?.error || data?.message || `HTTP ${res.status}`;
          throw new Error(errMsg);
        }

        return data;
      } finally {
        clearTimeout(timeoutId);
      }
    }

    // ----------------- Submit -----------------
    async function onSubmit(){
      if (state.submitting) return;

      // simple throttle
      const now = Date.now();
      if (now - state.lastSubmitAt < 1500) return;
      state.lastSubmitAt = now;

      const missing = step1MissingFields();
      if (missing.length){
        showStep(1);
        byId('step1-hint').textContent = `Faltan datos: ${missing.join(', ')}`;
        postHeightToWix();
        return;
      }

      if (!step2Valid()){
        showStep(2);
        byId('step2-hint').textContent = 'Selecciona el tipo de servicio.';
        postHeightToWix();
        return;
      }

      if (!step3Valid()){
        showStep(3);
        byId('step3-hint').textContent = 'Completa la configuraci√≥n del paso 3.';
        postHeightToWix();
        return;
      }

      if (!step5Valid()){
        showStep(5);
        byId('step5-hint').textContent = 'Revisa los datos de contacto.';
        postHeightToWix();
        return;
      }

      state.submitting = true;
      setMsg('Enviando...', true);

      const payload = collectPayload();

      trackEvent('generate_lead', {
        brand: payload.marca,
        model: payload.modelo,
        year: payload.a√±o,
        flow: payload.flow,
        send_channel: payload.send_channel
      });

      try{
        await postToWebhook(payload);

        trackEvent('form_submitted_success', { flow: payload.flow, send_channel: payload.send_channel });
        setMsg('¬°Enviado! Te contactamos en breve.', true);

        resetFormAfterSuccess();
      } catch(e){
        console.error('submit error:', e);

        const msg = String(e?.message || '').toLowerCase();
        const isValidation = msg.includes('validation') || msg.includes('missing') || msg.includes('invalid');

        if (!isValidation){
          enqueuePending(payload);
          setMsg('Error temporal. Hemos guardado tu solicitud y la reintentaremos autom√°ticamente.', false);
        } else {
          setMsg('Error: revisa los campos e int√©ntalo de nuevo.', false);
        }
      } finally {
        state.submitting = false;
        postHeightToWix();
      }
    }

    // ----------------- Init -----------------
    async function init(){
      trackEvent('form_page_view', { ref: document.referrer || '' });

      initPhone();

      // Load UI + catalogs
      await loadUIFields();

      await Promise.all([
        loadBrands(),
        loadModels(''),
        loadYears(),
        loadInstallCenters(),
        loadFinishes(),
        loadFilmBrands()
      ]);

      await loadPriceUI();

      if (ui.ready) applyUI();

      // Step1 listeners
      byId('brand').addEventListener('change', async (e)=>{
        state.brand = e.target.value || '';
        state.model = '';
        byId('model').value = '';
        await loadModels(state.brand);
        updateStep1UI();
      });

      byId('model').addEventListener('change', (e)=>{
        state.model = e.target.value || '';
        updateStep1UI();
      });

      byId('year').addEventListener('change', (e)=>{
        state.year = e.target.value || '';
        updateStep1UI();
      });

      byId('install_center').addEventListener('change', ()=>{
        updateStep1UI();
      });

      byId('next-1').addEventListener('click', ()=>{
        const missing = step1MissingFields();
        if (missing.length){
          byId('step1-hint').textContent = `Faltan datos: ${missing.join(', ')}`;
          postHeightToWix();
          return;
        }
        byId('step1-hint').textContent = '';
        showStep(2);
      });

      // Step2 listeners
      byId('back-2').addEventListener('click', ()=> showStep(1));

      byId('choose-total').addEventListener('click', ()=>{
        state.flow = 'total';
        byId('choose-total').classList.add('active');
        byId('choose-parts').classList.remove('active');
        byId('step2-hint').textContent = '';
        postHeightToWix();
      });

      byId('choose-parts').addEventListener('click', ()=>{
        state.flow = 'parts';
        byId('choose-parts').classList.add('active');
        byId('choose-total').classList.remove('active');
        byId('step2-hint').textContent = '';
        postHeightToWix();
      });

      byId('next-2').addEventListener('click', ()=>{
        if (!step2Valid()){
          byId('step2-hint').textContent = 'Selecciona el tipo de servicio.';
          postHeightToWix();
          return;
        }
        byId('step2-hint').textContent = '';

        // show correct 3A/3B blocks
        byId('block-packages').classList.toggle('hidden', state.flow !== 'total');
        byId('block-parts').classList.toggle('hidden', state.flow !== 'parts');

        showStep(3);
      });

      // Step3 listeners
      byId('back-3').addEventListener('click', ()=> showStep(2));

      byId('finish').addEventListener('change', ()=> syncFinish('finish'));
      byId('finish_parts').addEventListener('change', ()=> syncFinish('finish_parts'));

      // Film brand (optional) sync (3A <-> 3B)
      byId('film_brand')?.addEventListener('change', ()=> syncFilmBrand('a'));
      byId('film_brand_parts')?.addEventListener('change', ()=> syncFilmBrand('b'));

      byId('next-3').addEventListener('click', ()=>{
        if (state.flow === 'total'){
          if (!state.selectedPackage) { byId('step3-hint').textContent = 'Selecciona un paquete.'; postHeightToWix(); return; }
          if (!state.finish_key) { byId('step3-hint').textContent = 'Selecciona el tipo de cobertura.'; postHeightToWix(); return; }
        }
        if (state.flow === 'parts'){
          if (!state.selectedParts.size) { byId('step3-hint').textContent = 'Selecciona al menos una parte.'; postHeightToWix(); return; }
          if (!state.finish_key) { byId('step3-hint').textContent = 'Selecciona el tipo de cobertura.'; postHeightToWix(); return; }
        }

        byId('step3-hint').textContent = '';
        showStep(4);
      });

      // Step4 listeners
      byId('back-4').addEventListener('click', ()=> showStep(3));
      byId('next-4').addEventListener('click', ()=> showStep(5));

      // Step5 listeners
      byId('back-5').addEventListener('click', ()=> showStep(4));

      byId('send-tab-email').addEventListener('click', ()=>{
        state.send_channel = 'email';
        byId('send-tab-email').classList.add('active');
        byId('send-tab-wa').classList.remove('active');
        byId('send-tab-email').setAttribute('aria-selected','true');
        byId('send-tab-wa').setAttribute('aria-selected','false');
        postHeightToWix();
      });

      byId('send-tab-wa').addEventListener('click', ()=>{
        state.send_channel = 'whatsapp';
        byId('send-tab-wa').classList.add('active');
        byId('send-tab-email').classList.remove('active');
        byId('send-tab-wa').setAttribute('aria-selected','true');
        byId('send-tab-email').setAttribute('aria-selected','false');
        postHeightToWix();
      });

      byId('name_client').addEventListener('input', validateName);
      byId('phone').addEventListener('input', validatePhone);
      byId('email_client').addEventListener('input', validateEmail);
      byId('consent').addEventListener('change', validateConsent);

      byId('submit').addEventListener('click', onSubmit);

      // Initial state
      showStep(1);

      // Retry pending queue
      setTimeout(flushPending, 1000);

      postHeightToWix();
    }

    init();
  </script>
</body>
</html>
