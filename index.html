<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Presupuesto Online - PPF Barcelona</title>
  <meta name="description" content="Calcula tu presupuesto de protecci칩n PPF en menos de 2 minutos. Sin compromiso." />

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.1.6/dist/purify.min.js"></script>

  <!-- intl-tel-input -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/intl-tel-input@23.8.0/build/css/intlTelInput.min.css">
  <script src="https://cdn.jsdelivr.net/npm/intl-tel-input@23.8.0/build/js/intlTelInput.min.js"></script>

  <!-- Google Analytics 4 (replace with your ID) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-XXXXXXXXXX"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-XXXXXXXXXX'); // Replace with your GA4 ID
  </script>

  <!-- Facebook Pixel (replace with your ID) -->
  <script>
    !function(f,b,e,v,n,t,s)
    {if(f.fbq)return;n=f.fbq=function(){n.callMethod?
    n.callMethod.apply(n,arguments):n.queue.push(arguments)};
    if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
    n.queue=[];t=b.createElement(e);t.async=!0;
    t.src=v;s=b.getElementsByTagName(e)[0];
    s.parentNode.insertBefore(t,s)}(window, document,'script',
    'https://connect.facebook.net/en_US/fbevents.js');
    // fbq('init', 'YOUR_PIXEL_ID'); // Uncomment and replace
    // fbq('track', 'PageView');
  </script>

  <style>
    body { background:#121212; color:#fff; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }

    /* UPDATED: layout */
    .card { background:#1c1c1c; border:1px solid #2a2a2a; min-height: 520px; display:flex; flex-direction:column; }

    .accent { color:#f5bf00; }
    label.small { font-size:.95rem; color:#cfcfcf; }

    .field, select, input[type="text"], input[type="number"], input[type="email"], input[type="tel"], textarea {
      background:#111; color:#eee; border:1px solid #2a2a2a; border-radius:.75rem; padding:.65rem .8rem;
      outline: none; transition: border-color .15s, box-shadow .15s;
    }
    .field:focus { border-color: #f5bf00; box-shadow: 0 0 0 2px rgba(245,191,0,.15); }
    .field:disabled { opacity:.6; cursor: not-allowed; }

    .section-title { color:#eaeaea; font-weight:800; margin-top:.25rem; }

    .btn-yellow {
      background:#f5bf00; color:#111; font-weight:800; border-radius:9999px; padding:.8rem 2.2rem;
      transition: transform .1s, box-shadow .15s; cursor: pointer; border: none;
    }
    .btn-yellow:hover:not(:disabled) { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(245,191,0,.3); }
    .btn-yellow:active:not(:disabled) { transform: translateY(0); }
    .btn-yellow:disabled { opacity:.45; cursor:not-allowed; }

    .btn-ghost {
      border:1px solid #3a3a3a; color:#eaeaea; border-radius:9999px; padding:.75rem 1.5rem;
      background: transparent; transition: background .15s, border-color .15s; cursor: pointer;
    }
    .btn-ghost:hover:not(:disabled) { background:#1a1a1a; border-color:#4a4a4a; }
    .btn-ghost:disabled { opacity:.45; cursor: not-allowed; }

    .hint { color:#cfcfcf; }
    .error { color:#ff6a3d; }
    .ok { color:#7CFC9A; }

    .step-dot { width:10px; height:10px; border-radius:9999px; background:#3a3a3a; transition: background .2s; }
    .step-dot.active { background:#f5bf00; }

    .radio-card {
      border:1px solid #2a2a2a; background:#141414;
      border-radius:1rem; padding:1rem;
      display:flex; gap:.75rem; align-items:flex-start;
      cursor:pointer; transition: all .15s;
    }
    .radio-card:hover { background:#1a1a1a; border-color:#3a3a3a; }
    .radio-card:focus { outline: 2px solid #f5bf00; outline-offset: 2px; }
    .radio-card.active { border-color:#f5bf00; background:#1a1603; }

    .choice-grid { display:grid; grid-template-columns:1fr; gap:.75rem; }
    @media (min-width: 768px){ .choice-grid { grid-template-columns:1fr 1fr 1fr; } }

    .seg { border:1px solid #2a2a2a; background:#151515; }
    .seg button { color:#b9b9b9; transition: all .15s; }
    .seg button:hover { color:#eaeaea; }
    .seg button.active { color:#111; background:#f5bf00; }

    .row {
      border:1px solid #2a2a2a; background:#131313;
      transition: all .15s; cursor: pointer;
    }
    .row:hover { background:#1a1a1a; border-color:#3a3a3a; }
    .row.selected { border-color:#f5bf00; background:#161203; }

    .check {
      width:18px; height:18px; border-radius:4px;
      border:1px solid #3a3a3a; background:#0f0f0f; display:grid; place-items:center;
      flex: 0 0 auto; transition: all .15s;
    }
    .row.selected .check { border-color:#f5bf00; background:#f5bf00; }
    .row.selected .check svg { display:block; }
    .check svg { display:none; }

    /* Bottom Sheet (WIX-safe) */
    .sheet-backdrop{
      position:fixed; inset:0;
      background:rgba(0,0,0,.55);
      z-index:2147483646; /* 햪햟햨혜햦햪햟햩혧햫혦햧 쮏쒫왐혠 Wix */
      display:none;
      pointer-events:auto;
    }
    .sheet-backdrop.open{ display:block; }

    .sheet{
      position:fixed;
      left:0; right:0; bottom:0;

      transform: translateY(110%);
      transform-origin: bottom;
      background:#161616;
      border-top-left-radius:18px; border-top-right-radius:18px;
      border:1px solid #2a2a2a; border-bottom:0;

      z-index:2147483647; /* 쒬혣햣 backdrop */
      transition: transform .22s ease;
      height: min(75vh, 560px);
      overflow:auto;
      padding-bottom: env(safe-area-inset-bottom);
      -webkit-overflow-scrolling: touch;
      pointer-events:auto;
      display:block;
    }
    .sheet.open{ transform: translateY(0) !important; }

    html.noscroll, body.noscroll{
      overflow:hidden !important;
      touch-action:none;
    }

    .grab { width:46px; height:5px; border-radius:9999px; background:#3a3a3a; margin:10px auto; }

    .warnbox {
      border:1px solid rgba(245,191,0,.45);
      background: rgba(245,191,0,.08);
      border-radius: .9rem;
      padding: .9rem;
      color:#eaeaea;
    }
    .warnbox .title { font-weight:800; margin-bottom: .5rem; }

    .field.invalid { border-color: #ff6a3d !important; box-shadow: 0 0 0 2px rgba(255,106,61,.15); }
    .field.valid { border-color: rgba(124,252,154,.55) !important; box-shadow: 0 0 0 2px rgba(124,252,154,.10); }

    .tiny { font-size: .85rem; color:#b9b9b9; line-height: 1.5; }
    .tiny a { text-decoration: underline; color:#f5bf00; }
    .tiny a:hover { color:#ffd740; }

    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0,0,0,0);
      white-space: nowrap;
      border-width: 0;
    }

    .spinner {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid #3a3a3a;
      border-top-color: #f5bf00;
      border-radius: 50%;
      animation: spin 0.6s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* intl-tel-input: make input match your UI */
    .iti { width: 100%; }
    .iti__country-list { background:#111; color:#eee; border:1px solid #2a2a2a; }
    .iti__country.iti__highlight { background:#1a1a1a; }
    .iti__divider { border-color:#2a2a2a; }
  </style>
</head>

<body>
  <div id="form-top" class="max-w-3xl mx-auto px-5 py-8">
    <h1 id="hero-title" class="text-2xl md:text-3xl font-extrabold text-center accent tracking-wide">
      PRESUPUESTO ONLINE EN MENOS DE 2 MINUTOS
    </h1>
    <p id="hero-subtitle" class="text-center mt-2 hint">
      Precio orientativo sin compromiso. Te lo enviamos por WhatsApp o Email.
    </p>

    <div class="card rounded-2xl p-5 md:p-6 mt-6 space-y-5">

      <!-- Progress -->
      <div class="flex items-center justify-between">
        <div class="flex items-center gap-2">
          <div class="step-dot" id="dot-1"></div>
          <div class="step-dot" id="dot-2"></div>
          <div class="step-dot" id="dot-3"></div>
          <div class="step-dot" id="dot-4"></div>
          <div class="step-dot" id="dot-5"></div>
        </div>
        <div class="text-sm text-slate-300" id="step-label">Paso 1 de 5</div>
      </div>

      <!-- STEP 1 -->
      <section id="step-1" class="space-y-4">
        <h2 id="step1-title" class="section-title" tabindex="-1">1) Tu coche</h2>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div id="wrap-brand">
            <label class="small block mb-1" for="brand">
              <span id="lbl-brand">Marca</span> <span id="star-brand" class="accent">*</span>
            </label>
            <select id="brand" class="w-full field" required>
              <option value="">Cargando marcas...</option>
            </select>
          </div>

          <div id="wrap-model">
            <label class="small block mb-1" for="model">
              <span id="lbl-model">Modelo</span> <span id="star-model" class="accent">*</span>
            </label>
            <select id="model" class="w-full field" disabled required>
              <option value="">Selecciona una marca</option>
            </select>
          </div>

          <div id="wrap-year">
            <label class="small block mb-1" for="year">
              <span id="lbl-year">A침o</span> <span id="star-year" class="accent">*</span>
            </label>
            <select id="year" class="w-full field" required>
              <option value="">Cargando a침os...</option>
            </select>
          </div>
        </div>

        <div id="step1-hint" class="text-sm error"></div>

        <div class="flex justify-end pt-2">
          <button class="btn-yellow" id="next-1" type="button" disabled>Continuar</button>
        </div>
      </section>

      <!-- STEP 2 -->
      <section id="step-2" class="space-y-4 hidden">
        <h2 id="step2-title" class="section-title" tabindex="-1">2) 쯈u칠 quieres proteger?</h2>

        <div class="choice-grid">
          <button class="radio-card text-left" id="card-total" data-flow="total" type="button" aria-pressed="false">
            <div class="mt-1 w-3 h-3 rounded-full border border-[#141414]" id="dot-total"></div>
            <div>
              <div class="font-extrabold" id="flow-total-title">Protecci칩n Total</div>
              <div class="text-sm text-slate-300 mt-1" id="flow-total-desc">Paquetes recomendados (basico / avanzado / maximo).</div>
            </div>
          </button>

          <button class="radio-card text-left" id="card-custom" data-flow="custom" type="button" aria-pressed="false">
            <div class="mt-1 w-3 h-3 rounded-full border border-[#141414]" id="dot-custom"></div>
            <div>
              <div class="font-extrabold" id="flow-custom-title">Personalizar</div>
              <div class="text-sm text-slate-300 mt-1" id="flow-custom-desc">Selecciona partes concretas de la carrocer칤a.</div>
            </div>
          </button>

          <button class="radio-card text-left" id="card-otros" data-flow="otros" type="button" aria-pressed="false">
            <div class="mt-1 w-3 h-3 rounded-full border border-[#141414]" id="dot-otros"></div>
            <div>
              <div class="font-extrabold" id="flow-otros-title">Otros servicios</div>
              <div class="text-sm text-slate-300 mt-1" id="flow-otros-desc">Extras y servicios adicionales (sin partes).</div>
            </div>
          </button>
        </div>

        <div id="step2-hint" class="text-sm error"></div>

        <div class="flex justify-between pt-2">
          <button class="btn-ghost" id="back-2" type="button">Atr치s</button>
          <button class="btn-yellow" id="next-2" type="button" disabled>Continuar</button>
        </div>
      </section>

      <!-- STEP 3 -->
      <section id="step-3" class="space-y-4 hidden">
        <h2 class="section-title" id="step3-title" tabindex="-1">3) Configuraci칩n</h2>

        <!-- PACKAGES -->
        <div id="block-packages" class="space-y-3 hidden">
          <div class="rounded-xl border border-[#2a2a2a] bg-[#121212] p-4 space-y-3">
            <div class="font-extrabold" id="packages-title">Elige un paquete</div>
            <div class="text-sm text-slate-300" id="packages-desc">Selecciona basico, avanzado o maximo. Ajustamos detalles contigo despu칠s.</div>
            <div id="packages-buttons" class="grid grid-cols-1 md:grid-cols-3 gap-3"></div>
          </div>

          <div class="rounded-xl border border-[#2a2a2a] bg-[#121212] p-4 space-y-3">
            <div class="font-extrabold" id="finish-title-pack">Tipo de cobertura</div>

            <select id="finish" class="w-full field">
              <option value="">Cargando opciones...</option>
            </select>

            <div id="pack-warning-box" class="warnbox hidden space-y-2">
              <div class="title">丘멆잺 Importante</div>
              <div id="pack-warning-body" class="text-sm"></div>
            </div>
          </div>
        </div>

        <!-- PARTS (3B embedded) -->
        <div id="block-parts" class="space-y-3 hidden">
          <div class="rounded-xl border border-[#2a2a2a] bg-[#121212] p-4 space-y-3">
            <div>
              <h3 id="ui-title" class="text-lg font-extrabold">
                Selecci칩n de partes <span class="accent">(Carrocer칤a)</span>
              </h3>
              <p id="ui-subtitle" class="text-sm text-slate-300 mt-1"></p>
            </div>

            <div class="seg rounded-2xl p-1 flex gap-1" role="tablist" aria-label="Zonas">
              <button id="tab-frontal" class="w-full py-2 rounded-xl active" type="button" role="tab" aria-selected="true">Frontal</button>
              <button id="tab-lateral" class="w-full py-2 rounded-xl" type="button" role="tab" aria-selected="false">Lateral</button>
              <button id="tab-trasera" class="w-full py-2 rounded-xl" type="button" role="tab" aria-selected="false">Trasera</button>
            </div>

            <div class="mt-1 space-y-2" id="panel-list"></div>

            <button id="btn-view" class="btn-ghost w-full md:w-auto" type="button" disabled>
              Ver mi selecci칩n (0)
            </button>
          </div>

          <div class="rounded-xl border border-[#2a2a2a] bg-[#121212] p-4 space-y-3">
            <div class="font-extrabold" id="finish-title-parts">Tipo de cobertura</div>

            <select id="finish_parts" class="w-full field">
              <option value="">Cargando opciones...</option>
            </select>

            <div id="parts-warning-box" class="warnbox hidden space-y-2">
              <div class="title">丘멆잺 Importante</div>
              <div id="parts-warning-body" class="text-sm"></div>
            </div>
          </div>

          <div class="flex justify-between gap-3 pt-1">
            <button class="btn-ghost" id="back-3b" type="button">Atr치s</button>
            <button class="btn-yellow" id="next-3b" type="button" disabled>Continuar</button>
          </div>
        </div>

        <div id="step3-hint" class="text-sm error"></div>

        <div class="flex justify-between pt-2" id="step3-nav">
          <button class="btn-ghost" id="back-3" type="button">Atr치s</button>
          <button class="btn-yellow" id="next-3" type="button" disabled>Continuar</button>
        </div>
      </section>

      <!-- STEP 4 -->
      <section id="step-4" class="space-y-4 hidden">
        <h2 id="step4-title" class="section-title" tabindex="-1">4) Extras y servicios</h2>

        <div class="seg rounded-2xl p-1 flex gap-1" role="tablist" aria-label="Extras y Servicios">
          <button id="tab-step4-extras" class="w-full py-2 rounded-xl active" type="button" role="tab" aria-selected="true">Extras</button>
          <button id="tab-step4-servicios" class="w-full py-2 rounded-xl" type="button" role="tab" aria-selected="false">Servicios</button>
        </div>

        <div class="mt-3 space-y-2" id="step4-list"></div>

        <!-- UPDATED: mobile layout so buttons never fall off-screen -->
        <div class="pt-2 space-y-3 md:space-y-0 md:flex md:items-center md:justify-between md:gap-3">
          <div class="text-sm text-slate-300" id="step4-count">Ninguno seleccionado</div>

          <div class="grid grid-cols-2 gap-2 md:flex md:gap-2 md:justify-end">
            <button class="btn-ghost w-full md:w-auto" id="back-4" type="button">Atr치s</button>
            <button class="btn-yellow w-full md:w-auto" id="next-4" type="button">Continuar</button>
          </div>
        </div>

        <div id="step4-hint" class="text-sm error"></div>
      </section>

      <!-- STEP 5 -->
      <section id="step-5" class="space-y-4 hidden">
        <h2 id="step5-title" class="section-title" tabindex="-1">5) Contacto</h2>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="small block mb-1" for="name_client">
              <span id="lbl-name">Nombre</span> <span id="star-name" class="accent">*</span>
            </label>
            <input id="name_client" class="w-full field" type="text" placeholder="Tu nombre" required autocomplete="name" />
            <div id="name-hint" class="text-xs error mt-1 hidden"></div>
          </div>
          <div>
            <label class="small block mb-1" for="phone">
              <span id="lbl-phone">Tel칠fono</span> <span id="star-phone" class="accent">*</span>
            </label>
            <input id="phone" class="w-full field" type="tel" placeholder="+34 600 00 00 00" required inputmode="tel" autocomplete="tel" />
            <div id="phone-hint" class="text-xs error mt-1 hidden"></div>
          </div>
          <div class="md:col-span-2">
            <label class="small block mb-1" for="email_client">
              <span id="lbl-email">Email</span> <span id="star-email" class="accent">*</span>
            </label>
            <input id="email_client" class="w-full field" type="email" placeholder="tu@email.com" required inputmode="email" autocomplete="email" />
            <div id="email-hint" class="text-xs error mt-1 hidden"></div>
          </div>
          <div class="md:col-span-2">
            <label class="small block mb-1" for="comment" id="lbl-comment">Comentario (opcional)</label>
            <textarea id="comment" class="w-full field" rows="3" placeholder="Ej.: quiero mate, uso en carretera, etc."></textarea>
          </div>

          <div class="md:col-span-2" id="wrap-center">
            <label class="small block mb-1" for="install_center" id="lbl-center">Centro de instalaci칩n (opcional)</label>
            <select id="install_center" class="w-full field">
              <option value="">Cargando centros...</option>
            </select>
          </div>
        </div>

        <div class="space-y-3 pt-2">
          <div class="rounded-xl border border-[#3a3a3a] bg-[#141414] p-4 space-y-3">
            <label class="flex items-start gap-3 cursor-pointer">
              <input
                type="checkbox"
                id="consent"
                class="w-5 h-5 accent-[#f5bf00] mt-0.5 cursor-pointer"
                required
              />
              <span id="privacy-text" class="text-sm text-slate-300 leading-relaxed">
                <strong>He le칤do y acepto</strong> la
                <a href="https://www.ppfbarcelona.es/pol%C3%ADtica-de-privacidad" target="_blank" rel="noopener noreferrer" class="underline">
                  Pol칤tica de privacidad
                </a>
                y el tratamiento de mis datos personales para gestionar mi solicitud de presupuesto.
              </span>
            </label>
            <div id="consent-hint" class="text-xs error hidden"></div>
          </div>

          <label class="flex items-center gap-2 cursor-pointer">
            <input id="promo" type="checkbox" class="w-4 h-4 accent-[#f5bf00] cursor-pointer" />
            <span id="promo-text" class="text-sm text-slate-300">Quiero recibir ofertas y novedades (opcional)</span>
          </label>
        </div>

        <div class="space-y-2 pt-2">
          <div id="send-question" class="text-sm font-semibold text-slate-200">쮻칩nde prefieres recibir el presupuesto?</div>
          <div class="seg rounded-2xl p-1 flex gap-1" role="tablist" aria-label="Canal de env칤o">
            <button id="send-tab-wa" class="w-full py-2 rounded-xl" type="button" role="tab" aria-selected="false">
              游님 WhatsApp
            </button>
            <button id="send-tab-email" class="w-full py-2 rounded-xl active" type="button" role="tab" aria-selected="true">
              游닎 Email
            </button>
          </div>
        </div>

        <div class="flex justify-between pt-3 gap-3">
          <button class="btn-ghost" id="back-5" type="button">Atr치s</button>
          <button id="submit" class="btn-yellow" type="button">
            <span id="submit-text">Enviar presupuesto</span>
            <span id="submit-spinner" class="hidden">
              <span class="spinner"></span> Enviando...
            </span>
          </button>
        </div>

        <div id="msg" class="text-sm"></div>
      </section>

    </div>
  </div>

  <!-- Bottom sheet -->
  <div id="backdrop" class="sheet-backdrop" aria-hidden="true"></div>
  <div id="sheet" class="sheet" role="dialog" aria-modal="true" aria-label="Tu selecci칩n">
    <div class="grab"></div>
    <div class="px-4 pb-5">
      <div class="flex items-center justify-between">
        <div class="text-lg font-extrabold" id="sheet-title">Tu selecci칩n</div>
        <button id="btn-close" class="btn-yellow" style="padding:.55rem 1.2rem" type="button">Cerrar</button>
      </div>
      <div id="sheet-list" class="mt-3 space-y-2"></div>
    </div>
  </div>

  <script>
    /// ========= CONFIGURATION =========
    const SUPABASE_URL = "https://ewaslsgyssyxvicobvaw.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImV3YXNsc2d5c3N5eHZpY29idmF3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY5MDMzMzIsImV4cCI6MjA4MjQ3OTMzMn0.pACJsbed_r3hdpGa0_9Fn5HMu2O323pdXh57usXL6Uc";
    const WEBHOOK_URL = "https://primary-production-8e17.up.railway.app/webhook/9d3ac003-abf6-446b-a415-18ba2b4affb3";
    const PRIVACY_URL = "https://www.ppfbarcelona.es/pol%C3%ADtica-de-privacidad";
    const FORM_KEY = "ppf_quote";
    // =================================

    const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
      auth: { persistSession: false, autoRefreshToken: false, detectSessionInUrl: false }
    });

    // Safety guard: never use SERVICE_ROLE_DO_NOT_USE_IN_BROWSER key in frontend
    function jwtRole(token){
      try{
        const part = token.split('.')[1];
        const json = JSON.parse(atob(part.replace(/-/g,'+').replace(/_/g,'/')));
        return json && json.role ? String(json.role) : '';
      } catch(e){ return ''; }
    }
    const _role = jwtRole(SUPABASE_ANON_KEY);
    if (_role === 'SERVICE_ROLE_DO_NOT_USE_IN_BROWSER'){
      console.error('SECURITY ERROR: SERVICE_ROLE_DO_NOT_USE_IN_BROWSER key detected. Replace with anon public key.');
      const b = document.createElement('div');
      b.className = 'max-w-3xl mx-auto px-5 py-3';
      b.innerHTML = '<div class="warnbox"><div class="title">Configuraci칩n incorrecta</div><div class="text-sm">Est치s usando <b>SERVICE_ROLE_DO_NOT_USE_IN_BROWSER</b> en el navegador. Sustituye SUPABASE_ANON_KEY por la <b>anon public key</b> del proyecto de cat치logos.</div></div>';
      document.body.prepend(b);
    }

    const byId = (id) => document.getElementById(id);

    // Cache common DOM
    const msgEl = byId('msg');
    const stepLabelEl = byId('step-label');
    const steps = [1,2,3,4,5].map(i => byId(`step-${i}`));
    const dots = [1,2,3,4,5].map(i => byId(`dot-${i}`));

    // intl-tel-input instance
    let iti = null;

    // Helpers
    const norm = (s) => (s || '').toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'').trim();

    function escapeHtml(text){
      const div = document.createElement('div');
      div.textContent = String(text ?? '');
      return div.innerHTML;
    }

    function setMsg(text, ok=true){
      msgEl.textContent = text || '';
      msgEl.className = ok ? 'text-sm ok' : 'text-sm error';
    }

    function blurActive(){
      try {
        if (document.activeElement && document.activeElement.blur) {
          document.activeElement.blur();
        }
      } catch(e){}
    }

    function announceToScreenReader(message){
      const el = document.createElement('div');
      el.setAttribute('role', 'status');
      el.setAttribute('aria-live', 'polite');
      el.className = 'sr-only';
      el.textContent = message;
      document.body.appendChild(el);
      setTimeout(() => el.remove(), 1000);
    }

    function trackEvent(eventName, params = {}){
      try {
        if (window.gtag){
          gtag('event', eventName, params);
        }
      } catch(e){
        console.warn('Analytics tracking failed:', e);
      }
    }

    // Wix auto-height: postMessage -> Velo changes iframe height
    function postHeightToWix(){
      try{
        const h = Math.max(
          document.documentElement.scrollHeight || 0,
          document.body.scrollHeight || 0
        );
        window.parent?.postMessage({ type: 'PPF_FORM_HEIGHT', h }, '*');
      } catch(e){}
    }

    // ---------- UI from ui_form_fields ----------
    const ui = { map: new Map(), ready: false };

    function parseMeta(m){
      if (!m) return {};
      if (typeof m === 'object') return m;
      if (typeof m === 'string'){
        try { return JSON.parse(m); } catch(e){ return {}; }
      }
      return {};
    }

    function uiRow(key){ return ui.map.get(String(key)) || null; }
    function uiLabel(key, fallback=''){
      const r = uiRow(key);
      const v = r?.label;
      return (v != null && String(v).trim() !== '') ? String(v) : fallback;
    }
    function uiMeta(key){
      const r = uiRow(key);
      return parseMeta(r?.meta);
    }
    function uiEnabled(key, fallback=true){
      const r = uiRow(key);
      if (!r) return fallback;
      return r.enabled !== false;
    }
    function uiRequired(key, fallback=false){
      const r = uiRow(key);
      if (!r) return fallback;
      return r.required === true;
    }

    function stripStar(s){ return String(s||'').replace(/\*/g,'').trim(); }
    function setStar(starId, required){
      const el = byId(starId);
      if (!el) return;
      el.style.display = required ? '' : 'none';
    }
    function setText(id, text){
      const el = byId(id);
      if (!el) return;
      el.textContent = String(text ?? '');
    }
    function setHTML(id, html){
      const el = byId(id);
      if (!el) return;
      el.innerHTML = String(html ?? '');
    }

    function emphasizeParen(label){
      const s = String(label || '').trim();
      const m = s.match(/^(.*)\((.*)\)(.*)$/);
      if (!m) return escapeHtml(s);
      const before = escapeHtml(m[1]);
      const mid = escapeHtml('(' + m[2] + ')');
      const after = escapeHtml(m[3]);
      return `${before}<span class="accent">${mid}</span>${after}`;
    }

    function applyUI(){
      setText('hero-title', uiLabel('hero_title', byId('hero-title')?.textContent || ''));
      setText('hero-subtitle', uiLabel('hero_subtitle', byId('hero-subtitle')?.textContent || ''));

      setText('step1-title', uiLabel('step1_title', byId('step1-title')?.textContent || ''));
      setText('step2-title', uiLabel('step2_title', byId('step2-title')?.textContent || ''));
      setText('step4-title', uiLabel('step4_title', byId('step4-title')?.textContent || ''));
      setText('step5-title', uiLabel('step5_title', byId('step5-title')?.textContent || ''));

      setText('lbl-brand', stripStar(uiLabel('brand', 'Marca')));
      setText('lbl-model', stripStar(uiLabel('model', 'Modelo')));
      setText('lbl-year',  stripStar(uiLabel('year', 'A침o')));
      setStar('star-brand', uiRequired('brand', true));
      setStar('star-model', uiRequired('model', true));
      setStar('star-year',  uiRequired('year', true));

      setText('flow-total-title', uiLabel('flow_total', 'Protecci칩n Total'));
      setText('flow-custom-title', uiLabel('flow_custom', 'Personalizar'));
      setText('flow-otros-title', uiLabel('flow_otros', 'Otros servicios'));

      setText('flow-total-desc', (uiMeta('flow_total_desc').text || ''));
      setText('flow-custom-desc', (uiMeta('flow_custom_desc').text || ''));
      setText('flow-otros-desc', (uiMeta('flow_otros_desc').text || ''));

      setText('back-2', uiLabel('btn_back_2', byId('back-2')?.textContent || 'Atr치s'));
      setText('next-2', uiLabel('btn_next_2', byId('next-2')?.textContent || 'Continuar'));

      setText('back-3', uiLabel('btn_back_3', byId('back-3')?.textContent || 'Atr치s'));
      setText('next-3', uiLabel('btn_next_3', byId('next-3')?.textContent || 'Continuar'));
      setText('back-3b', uiLabel('btn_back_3b', byId('back-3b')?.textContent || 'Atr치s'));
      setText('next-3b', uiLabel('btn_next_3b', byId('next-3b')?.textContent || 'Continuar'));

      setText('packages-title', uiLabel('packages_title', byId('packages-title')?.textContent || 'Elige un paquete'));
      const def = uiMeta('packages_title').default_text || byId('packages-desc')?.textContent || '';
      setText('packages-desc', def);

      setText('finish-title-pack', uiLabel('finish', byId('finish-title-pack')?.textContent || 'Tipo de cobertura'));
      setText('finish-title-parts', uiLabel('finish', byId('finish-title-parts')?.textContent || 'Tipo de cobertura'));

      const partsLabel = uiLabel('parts_block_title', 'Selecci칩n de partes (Carrocer칤a)');
      setHTML('ui-title', emphasizeParen(partsLabel));
      const partsSub = uiMeta('parts_block_title').subtitle || '';
      setText('ui-subtitle', partsSub);

      setText('tab-frontal', uiLabel('tab_frontal', byId('tab-frontal')?.textContent || 'Frontal'));
      setText('tab-lateral', uiLabel('tab_lateral', byId('tab-lateral')?.textContent || 'Lateral'));
      setText('tab-trasera', uiLabel('tab_trasera', byId('tab-trasera')?.textContent || 'Trasera'));

      setText('sheet-title', uiLabel('sheet_title', byId('sheet-title')?.textContent || 'Tu selecci칩n'));
      setText('btn-close', uiLabel('sheet_btn_close', byId('btn-close')?.textContent || 'Cerrar'));

      setText('tab-step4-extras', uiLabel('extras', byId('tab-step4-extras')?.textContent || 'Extras'));
      setText('tab-step4-servicios', uiLabel('servicios', byId('tab-step4-servicios')?.textContent || 'Servicios'));
      setText('back-4', uiLabel('btn_back_4', byId('back-4')?.textContent || 'Atr치s'));
      setText('next-4', uiLabel('btn_next_4', byId('next-4')?.textContent || 'Continuar'));
      setText('step4-count', uiLabel('step4_none_selected', byId('step4-count')?.textContent || 'Ninguno seleccionado'));

      setText('lbl-name', stripStar(uiLabel('name_client', 'Nombre')));
      setText('lbl-phone', stripStar(uiLabel('phone', 'Tel칠fono')));
      setText('lbl-email', stripStar(uiLabel('email_client', 'Email')));
      setStar('star-name', uiRequired('name_client', true));
      setStar('star-phone', uiRequired('phone', true));
      setStar('star-email', uiRequired('email_client', true));

      setText('lbl-comment', uiLabel('comment', byId('lbl-comment')?.textContent || 'Comentario (opcional)'));

      const centerEnabled = uiEnabled('center', true);
      byId('wrap-center')?.classList.toggle('hidden', !centerEnabled);
      setText('lbl-center', uiLabel('center', byId('lbl-center')?.textContent || 'Centro de instalaci칩n (opcional)'));

      setText('promo-text', uiLabel('promo', byId('promo-text')?.textContent || ''));
      setText('send-question', uiLabel('send_channel_question', byId('send-question')?.textContent || ''));

      const waLabel = uiLabel('cta_whatsapp', 'WhatsApp');
      const emLabel = uiLabel('cta_email', 'Email');

      const waCore = String(waLabel).replace(/^enviar\s+por\s+/i,'').trim() || 'WhatsApp';
      const emCore = String(emLabel).replace(/^enviar\s+por\s+/i,'').trim() || 'Email';

      setText('send-tab-wa', `游님 ${waCore}`);
      setText('send-tab-email', `游닎 ${emCore}`);

      setText('back-5', uiLabel('btn_back_5', byId('back-5')?.textContent || 'Atr치s'));
      setText('submit-text', uiLabel('btn_submit', byId('submit-text')?.textContent || 'Enviar presupuesto'));

      const p = uiMeta('privacy_text');
      if (p && (p.text || p.url || p.link_text)){
        const url = p.url || PRIVACY_URL;
        const linkText = p.link_text || 'Pol칤tica de privacidad';
        const fullText = p.text || '';

        const idx = fullText.indexOf(linkText);
        const before = idx >= 0 ? fullText.slice(0, idx) : fullText;
        const after = idx >= 0 ? fullText.slice(idx + linkText.length) : '';

        const strongPhrase = 'He le칤do y acepto';
        const beforeEsc = escapeHtml(before);
        const afterEsc = escapeHtml(after);

        const beforeHtml = beforeEsc.replace(
          escapeHtml(strongPhrase),
          `<strong>${escapeHtml(strongPhrase)}</strong>`
        );

        const a = `<a href="${escapeHtml(url)}" target="_blank" rel="noopener noreferrer" class="underline">${escapeHtml(linkText)}</a>`;
        const html = `${beforeHtml}${a}${afterEsc}`.trim();
        if (html) setHTML('privacy-text', html);
      }

      ui.ready = true;
    }

    async function loadUIFields(){
      try{
        const { data } = await sb
          .from('v_catalog_ui_form_fields')
          .select('field_key,step,label_es,enabled,required,sort_order,meta')
          .order('sort_order', { ascending: true })
          .throwOnError();

        ui.map.clear();
        (data || []).forEach(r => {
          if (r && r.field_key) ui.map.set(String(r.field_key), r);
        });

        applyUI();
      } catch(e){
        console.warn('ui_form_fields load failed:', e);
      }
    }

    // ----------------- FALLBACK QUEUE (localStorage) -----------------
    const PENDING_KEY = `${FORM_KEY}_pending_queue_v1`;

    function readPending(){
      try{
        const raw = localStorage.getItem(PENDING_KEY);
        const arr = raw ? JSON.parse(raw) : [];
        return Array.isArray(arr) ? arr : [];
      } catch(e){
        return [];
      }
    }

    function writePending(arr){
      try{
        localStorage.setItem(PENDING_KEY, JSON.stringify(arr || []));
      } catch(e){}
    }

    function enqueuePending(payload){
      const arr = readPending();
      arr.push({ ts: Date.now(), payload });
      writePending(arr);
    }

    async function flushPending(){
      const arr = readPending();
      if (!arr.length) return;

      const keep = [];
      for (let i = 0; i < arr.length; i++){
        const item = arr[i];
        try{
          await postToWebhook(item.payload, { silent: true });
        } catch(e){
          keep.push(item, ...arr.slice(i + 1));
          break;
        }
      }
      writePending(keep);
    }

    // App data
    const appData = {
      centers: new Map(),
      finishes: new Map(),
      partsCatalog: { frontal: [], lateral: [], trasera: [] },
      extrasList: [],
      serviciosList: []
    };

    // ----------------- STATE -----------------
    const state = {
      step: 1,
      prevStep: null,
      flow: "",

      brand: "",
      model: "",
      year: "",

      install_center_id: "",
      install_center_title: "",

      finish_key: "",
      finish_title: "",
      finish_allow_partial: true,
      finish_warning_partial: "",

      selectedPackage: "",
      selectedParts: new Set(),
      selectedExtras: new Set(),
      selectedServicios: new Set(),

      send_channel: "email",

      step4BackTarget: 3,
      startedAt: Date.now(),

      submitting: false,
      lastSubmitAt: 0
    };

    // ----------------- STEP CONTROL -----------------
    function stepLabelText(step){
      const tpl = uiLabel('step_label_template', 'Paso {step} de 5');
      return String(tpl).replace('{step}', String(step));
    }

    function scrollToFormTop(){
      const top = byId('form-top');
      if (top) top.scrollIntoView({ behavior: 'smooth', block: 'start' });
      else window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function showStep(n){
      blurActive();
      state.prevStep = state.step;
      state.step = n;

      steps.forEach((el, idx) => el.classList.toggle('hidden', (idx+1) !== n));
      dots.forEach((el, idx) => el.classList.toggle('active', (idx+1) === n));

      stepLabelEl.textContent = stepLabelText(n);

      scrollToFormTop();
      postHeightToWix();

      const heading = byId(`step-${n}`)?.querySelector('.section-title');
      if (heading){
        heading.setAttribute('tabindex','-1');
        setTimeout(() => {
          heading.focus({ preventScroll: true });
          announceToScreenReader(stepLabelText(n));
        }, 100);
      }

      trackEvent('form_step_viewed', {
        step: n,
        flow: state.flow,
        time_elapsed: Math.round((Date.now() - state.startedAt) / 1000)
      });
    }

    // ----------------- LOAD: Brands/Models/Years -----------------
    function placeholderText(key, fallback){
      const t = uiLabel(key, '');
      return (t && t.trim()) ? t.trim() : fallback;
    }    async function loadBrands(){
      const el = byId('brand');
      el.disabled = true;
      el.innerHTML = '<option value="">Cargando marcas...</option>';
      try{
        const { data } = await sb.from('v_catalog_brands')
          .select('brand')
          .order('brand', { ascending:true })
          .throwOnError();

        const brands = [...new Set((data||[]).map(r=>r.brand).filter(Boolean))];

        const ph = placeholderText('brand_placeholder', 'Selecciona una marca');
        el.innerHTML =
          `<option value="" disabled selected>${escapeHtml(ph)}</option>` +
          brands.map(b=>`<option value="${escapeHtml(b)}">${escapeHtml(b)}</option>`).join('');
      } catch(e){
        console.error('loadBrands:', e);
        el.innerHTML = '<option value="">Error al cargar marcas. Recarga la p치gina.</option>';
      } finally {
        el.disabled = false;
      }
    }    async function loadModels(brand){
      const el = byId('model');
      el.disabled = true;

      if (!brand){
        const ph = placeholderText('model_placeholder', 'Selecciona un modelo');
        el.innerHTML = `<option value="" disabled selected>${escapeHtml(ph)}</option>`;
        el.disabled = true;
        return;
      }

      el.innerHTML = '<option value="">Cargando modelos...</option>';

      try{
        const { data } = await sb.from('v_catalog_models')
          .select('model')
          .eq('brand', brand)
          .order('model', { ascending:true })
          .throwOnError();

        const models = [...new Set((data||[]).map(r=>r.model).filter(Boolean))];
        const ph = placeholderText('model_placeholder', 'Selecciona un modelo');

        el.innerHTML =
          `<option value="" disabled selected>${escapeHtml(ph)}</option>` +
          models.map(m=>`<option value="${escapeHtml(m)}">${escapeHtml(m)}</option>`).join('');
      } catch(e){
        console.error('loadModels:', e);
        el.innerHTML = '<option value="">Error al cargar modelos.</option>';
      } finally {
        el.disabled = false;
      }
    }    async function loadYears(){
      const el = byId('year');
      el.disabled = true;
      el.innerHTML = '<option value="">Cargando a침os...</option>';
      try{
        const { data } = await sb.from('v_catalog_years')
          .select('year')
          .order('year', { ascending:false })
          .throwOnError();

        const years = [...new Set((data||[]).map(r=>String(r.year)).filter(Boolean))];
        const ph = placeholderText('year_placeholder', 'Selecciona un a침o');

        el.innerHTML =
          `<option value="" disabled selected>${escapeHtml(ph)}</option>` +
          years.map(y=>`<option value="${escapeHtml(y)}">${escapeHtml(y)}</option>`).join('');
      } catch(e){
        console.error('loadYears:', e);
        el.innerHTML = '<option value="">Error al cargar a침os.</option>';
      } finally {
        el.disabled = false;
      }
    }

    // ----------------- LOAD: install_centers -----------------


    // ----------------- LOAD: install_centers -----------------
    async function loadInstallCenters(){
      const el = byId('install_center');
      el.disabled = true;
      el.innerHTML = '<option value="">Cargando centros...</option>';
      try{
        // Prefer VIEW: already filtered (enabled=true) + safe columns
        const { data } = await sb
          .from('v_catalog_install_centers')
          .select('center_key,title_es,city')
          .order('sort_order', { ascending:true })
          .throwOnError();

        const rows = (data||[]).filter(r => r && r.center_key && r.title_es);

        const ph = placeholderText('center_placeholder', 'Selecciona una opci칩n');
        el.innerHTML =
          `<option value="">${escapeHtml(ph)}</option>` +
          rows.map(r => {
            const label = r.city ? `${r.title_es} (${r.city})` : r.title_es;
            return `<option value="${escapeHtml(String(r.center_key))}">${escapeHtml(String(label))}</option>`;
          }).join('');

        appData.centers = new Map(rows.map(r => [String(r.center_key), r]));
      } catch(e){
        console.error('loadInstallCenters:', e);
        el.innerHTML = '<option value="">Error al cargar centros.</option>';
      } finally {
        el.disabled = false;
      }
    }

    // ----------------- LOAD: Finishes -----------------


    // ----------------- LOAD: Finishes -----------------
    
    async function loadFinishes(){
      const finishSel = byId('finish');
      const finishSelParts = byId('finish_parts');
      finishSel.innerHTML = '<option value="">Cargando opciones...</option>';
      finishSelParts.innerHTML = '<option value="">Cargando opciones...</option>';

      try{
        const { data } = await sb.from('v_catalog_finishes')
          .select('finish_key,title_es,allow_partial,warning_partial,sort_order,form_key')
          .eq('form_key', FORM_KEY)
          .order('sort_order', { ascending:true })
          .throwOnError();

        // IMPORTANT: some schemas use title_es, others use title. We normalize to .title
        const rows = (data || [])
          .map(r => ({
            ...r,
            title: String((r && (r.title_es || r.title)) || '').trim()
          }))
          .filter(r => r.finish_key && r.title);

        const placeholder = placeholderText('finish_placeholder', 'Selecciona una opci칩n');

        const options =
          `<option value="" disabled selected>${escapeHtml(placeholder)}</option>` +
          rows.map(r => `<option value="${escapeHtml(String(r.finish_key))}">${escapeHtml(String(r.title))}</option>`).join('');

        finishSel.innerHTML = options;
        finishSelParts.innerHTML = options;

        appData.finishes = new Map(rows.map(r => [String(r.finish_key), r]));
      } catch(e){
        console.error('loadFinishes:', e);
        finishSel.innerHTML = '<option value="">Error al cargar opciones.</option>';
        finishSelParts.innerHTML = '<option value="">Error al cargar opciones.</option>';
      }
    }


    // ----------------- LOAD: catalog_services (replaces price_ui + price join) -----------------


    // ----------------- LOAD: price_ui + price (join) -----------------
    async function loadPriceUI(){
      try{
        const { data } = await sb.from('v_catalog_services')
          .select('service_key,title_es,service_type,sort_order,ui_step,ui_block,ui_group,ui_tab')
          .order('sort_order', { ascending:true })
          .throwOnError();

        const rows = (data||[]).filter(r=>r.service_key && r.title_es);

        const packages = rows
          .filter(r => r.ui_step === 3 && r.ui_block === 'paquetes' && r.service_type === 'basic')
          .map(r => ({ price_id: String(r.service_key), name: String(r.title_es), sort_order: r.sort_order }));

        renderPackages(packages);

        const parts = rows
          .filter(r => r.ui_step === 3 && r.ui_block === 'partes' && r.service_type === 'partial')
          .map(r => ({ price_id: String(r.service_key), name: String(r.title_es), group: r.ui_group, sort_order: r.sort_order }));

        const partsCatalog = { frontal: [], lateral: [], trasera: [] };
        for (const p of parts){
          const g = (p.group || '').toLowerCase();
          if (g === 'front') partsCatalog.frontal.push(p);
          else if (g === 'side') partsCatalog.lateral.push(p);
          else if (g === 'rear') partsCatalog.trasera.push(p);
        }
        appData.partsCatalog = partsCatalog;

        const extras = rows
          .filter(r => r.ui_step === 4 && r.ui_block === 'extras' && r.service_type === 'partial')
          .map(r => ({ price_id: String(r.service_key), name: String(r.title_es), sort_order: r.sort_order }));

        const servicios = rows
          .filter(r => r.ui_step === 4 && r.ui_block === 'servicios' && r.service_type === 'partial')
          .map(r => ({ price_id: String(r.service_key), name: String(r.title_es), sort_order: r.sort_order }));

        appData.extrasList = extras;
        appData.serviciosList = servicios;

        renderStep4List('extras');
      } catch(e){
        console.error('catalog_services load:', e);
        byId('packages-buttons').innerHTML = '<div class="text-sm error">Error cargando paquetes</div>';
        byId('panel-list').innerHTML = '<div class="text-sm error">Error cargando partes</div>';
      }
    }

    function packageInfoText(){
      const def = uiMeta('packages_title').default_text || byId('packages-desc')?.textContent || '';
      const dict = uiMeta('packages_text_by_package') || {};
      const key = norm(state.selectedPackage);
      if (key && dict && typeof dict === 'object'){
        if (dict[key]) return String(dict[key]);
      }
      return String(def || '');
    }

    function updatePackagesInfoUI(){
      const el = byId('packages-desc');
      if (!el) return;
      el.textContent = packageInfoText();
    }

    function renderPackages(list){
      const wrap = byId('packages-buttons');
      if (!list || !list.length){
        wrap.innerHTML = '<div class="text-sm text-slate-300">No hay paquetes configurados.</div>';
        return;
      }
      wrap.innerHTML = list.map(p => {
        const name = escapeHtml(p.name || '');
        const selected = state.selectedPackage === p.name;
        return `
          <button type="button"
            class="row rounded-2xl px-4 py-3 text-center font-extrabold ${selected ? 'selected' : ''}"
            data-package="${escapeHtml(p.name)}"
            aria-pressed="${selected ? 'true' : 'false'}">
            ${name}
          </button>
        `;
      }).join('');

      wrap.onclick = (e) => {
        const btn = e.target.closest('[data-package]');
        if (!btn) return;
        const pkg = btn.getAttribute('data-package') || '';
        state.selectedPackage = pkg;
        updatePackagesInfoUI();
        updatePartialWarningUI();
        updateStep3Buttons();
        renderPackages(list);
      };

      updatePackagesInfoUI();
    }

    // ----------------- VALIDATION STEP 1 -----------------
    function labelForMissing(key, fallback){ return stripStar(uiLabel(key, fallback)); }

    function step1MissingFields(){
      const miss = [];
      if (!byId('brand').value) miss.push(labelForMissing('brand', 'Marca'));
      if (!byId('model').value) miss.push(labelForMissing('model', 'Modelo'));
      if (!byId('year').value) miss.push(labelForMissing('year', 'A침o'));
      return miss;
    }

    function updateStep1UI(){
      const miss = step1MissingFields();
      byId('next-1').disabled = miss.length > 0;
      byId('step1-hint').textContent = miss.length ? ('Falta completar: ' + miss.join(', ') + '.') : '';
      postHeightToWix();
    }

    // ----------------- FLOW STEP 2 -----------------
    function hasSelections(){
      return !!state.selectedPackage ||
             state.selectedParts.size > 0 ||
             state.selectedExtras.size > 0 ||
             state.selectedServicios.size > 0 ||
             !!state.finish_key;
    }

    function resetSelections(){
      state.selectedPackage = '';
      state.selectedParts.clear();
      state.selectedExtras.clear();
      state.selectedServicios.clear();
      state.finish_key = '';
      state.finish_title = '';
      state.finish_allow_partial = true;
      state.finish_warning_partial = '';
      byId('finish').value = '';
      byId('finish_parts').value = '';
      updatePackagesInfoUI();
      updatePartialWarningUI();
      updateStep3Buttons();
      postHeightToWix();
    }

    function setFlow(flow){
      if (state.flow && state.flow !== flow && hasSelections()){
        const ok = confirm('Cambiar el tipo resetear치 tu selecci칩n. 쮺ontinuar?');
        if (!ok) return;
        resetSelections();
      }

      state.flow = flow;

      const cards = { total: byId('card-total'), custom: byId('card-custom'), otros: byId('card-otros') };
      const dots  = { total: byId('dot-total'),  custom: byId('dot-custom'),  otros: byId('dot-otros') };

      ['total','custom','otros'].forEach(k=>{
        cards[k].classList.toggle('active', k===flow);
        cards[k].setAttribute('aria-pressed', k===flow ? 'true' : 'false');
        dots[k].style.background = (k===flow) ? '#f5bf00' : 'transparent';
      });

      byId('next-2').disabled = !flow;
      byId('step2-hint').textContent = flow ? '' : 'Selecciona una opci칩n.';

      trackEvent('flow_selected', { flow });
      postHeightToWix();
    }

    // ----------------- FINISH -----------------
    function setFinishFromKey(k){
      state.finish_key = k || '';
      const row = appData.finishes.get(state.finish_key);
      state.finish_title = row?.title || '';
      state.finish_allow_partial = (row?.allow_partial !== false);
      state.finish_warning_partial = row?.warning_partial || '';
    }

    function isPartialContext(){
      if (state.flow === 'custom') return true;
      if (state.flow === 'otros') return true;
      if (state.flow === 'total'){
        const p = norm(state.selectedPackage);
        if (p === 'basico' || p === 'avanzado') return true;
      }
      return false;
    }

    function getWarningTextForContext(){
      if (state.finish_allow_partial === false){
        const base = (state.finish_warning_partial || '').trim();
        if (base) return base;

        return 'La protecci칩n parcial con pel칤cula mate o de color solo es posible si el veh칤culo tiene pintura mate de f치brica. ' +
               'En otros casos, recomendamos pel칤cula brillante o protecci칩n total. Este punto se revisa siempre durante la consulta final.';
      }
      return '';
    }

    function updatePartialWarningUI(){
      const needWarn = isPartialContext() && (state.finish_allow_partial === false) && !!state.finish_key;
      const txt = getWarningTextForContext();

      const packBox = byId('pack-warning-box');
      const partsBox = byId('parts-warning-box');

      if (state.flow === 'total' && needWarn){
        byId('pack-warning-body').textContent = txt;
        packBox.classList.remove('hidden');
      } else {
        packBox.classList.add('hidden');
        byId('pack-warning-body').textContent = '';
      }

      if (state.flow === 'custom' && needWarn){
        byId('parts-warning-body').textContent = txt;
        partsBox.classList.remove('hidden');
      } else {
        partsBox.classList.add('hidden');
        byId('parts-warning-body').textContent = '';
      }

      postHeightToWix();
    }

    // ----------------- STEP 3 -----------------
    function enterStep3(){
      byId('step3-hint').textContent = '';

      if (state.flow === 'total'){
        byId('step3-title').textContent = uiLabel('step3a_title', '3) Paquetes');
        byId('block-packages').classList.remove('hidden');
        byId('block-parts').classList.add('hidden');
        byId('step3-nav').classList.remove('hidden');
      } else if (state.flow === 'custom'){
        byId('step3-title').textContent = uiLabel('step3b_title', '3) Partes');
        byId('block-packages').classList.add('hidden');
        byId('block-parts').classList.remove('hidden');
        byId('step3-nav').classList.add('hidden');
        renderPartsTab('frontal');
      } else if (state.flow === 'otros'){
        state.step4BackTarget = 2;
        showStep(4);
        return;
      }

      updatePackagesInfoUI();
      updatePartialWarningUI();
      updateStep3Buttons();
      postHeightToWix();
    }

    function updateStep3Buttons(){
      const canPackages = !!state.selectedPackage && !!state.finish_key;
      byId('next-3').disabled = !(state.flow === 'total' && canPackages);

      const canParts = (state.selectedParts.size > 0) && !!state.finish_key;
      byId('next-3b').disabled = !(state.flow === 'custom' && canParts);

      updateViewButtonCount();
      postHeightToWix();
    }

    // ----------------- PARTS -----------------
    const partsUI = { activeTab: 'frontal' };

    function rowTemplatePrice(item, selected){
      const name = escapeHtml(item.name || '');
      const id = escapeHtml(item.price_id);
      return `
        <button class="row w-full rounded-2xl px-4 py-3 flex items-start gap-3 text-left ${selected ? 'selected':''}"
          type="button"
          data-id="${id}"
          aria-pressed="${selected ? 'true':'false'}">
          <div class="check mt-0.5" aria-hidden="true">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none">
              <path d="M20 6L9 17l-5-5" stroke="#111" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </div>
          <div class="flex-1">
            <div class="font-semibold text-[15px] leading-snug">${name}</div>
          </div>
        </button>
      `;
    }

    function renderPartsTab(tab){
      const panel = byId('panel-list');
      const cat = appData.partsCatalog;
      const list = cat[tab] || [];
      partsUI.activeTab = tab;

      ['frontal','lateral','trasera'].forEach(t=>{
        const btn = byId(`tab-${t}`);
        btn.classList.toggle('active', t===tab);
        btn.setAttribute('aria-selected', t===tab ? 'true' : 'false');
      });

      if (!list.length){
        panel.innerHTML = `<div class="text-sm text-slate-300">No hay opciones en esta secci칩n.</div>`;
        postHeightToWix();
        return;
      }

      panel.innerHTML = list.map(it=>{
        const id = String(it.price_id);
        const selected = state.selectedParts.has(id);
        return rowTemplatePrice(it, selected);
      }).join('');

      updateViewButtonCount();
      postHeightToWix();
    }

    byId('panel-list').addEventListener('click', (e)=>{
      const btn = e.target.closest('[data-id]');
      if (!btn) return;
      const id = String(btn.getAttribute('data-id') || '');
      if (!id) return;

      if (state.selectedParts.has(id)) state.selectedParts.delete(id);
      else state.selectedParts.add(id);

      renderPartsTab(partsUI.activeTab);
      updateStep3Buttons();
      if (byId('sheet').classList.contains('open')) renderSheet();
    });

    function updateViewButtonCount(){
      const n = state.selectedParts.size;
      const tpl = uiLabel('btn_view_selection_template', 'Ver mi selecci칩n ({count})');
      byId('btn-view').textContent = String(tpl).replace('{count}', String(n));
      byId('btn-view').disabled = (n === 0);
    }

    // ----------------- SHEET (WIX-safe + height sync) -----------------
    function openSheet(){
      byId('backdrop').classList.add('open');
      byId('sheet').classList.add('open');
      byId('backdrop').setAttribute('aria-hidden','false');

      document.documentElement.classList.add('noscroll');
      document.body.classList.add('noscroll');

      byId('sheet').scrollTop = 0;
      renderSheet();

      postHeightToWix();
    }
    function closeSheet(){
      byId('sheet').classList.remove('open');
      byId('backdrop').classList.remove('open');
      byId('backdrop').setAttribute('aria-hidden','true');

      document.documentElement.classList.remove('noscroll');
      document.body.classList.remove('noscroll');

      postHeightToWix();
    }

    function renderSheet(){
      const listEl = byId('sheet-list');
      const cat = appData.partsCatalog;
      const all = [...cat.frontal, ...cat.lateral, ...cat.trasera];

      const items = all
        .filter(it => state.selectedParts.has(String(it.price_id)))
        .sort((a,b)=> (a.sort_order??0)-(b.sort_order??0));

      if (!items.length){
        const empty = uiLabel('sheet_empty_text', 'No has seleccionado nada todav칤a.');
        listEl.innerHTML = `<div class="text-sm text-slate-300">${escapeHtml(empty)}</div>`;
        postHeightToWix();
        return;
      }

      const removeText = uiLabel('sheet_btn_remove', 'Quitar');

      listEl.innerHTML = items.map(it=>{
        const id = escapeHtml(String(it.price_id));
        const nm = escapeHtml(it.name);
        return `
          <div class="row rounded-2xl px-4 py-3 flex items-center gap-3">
            <div class="check" style="background:#f5bf00;border-color:#f5bf00;">
              <svg style="display:block" width="14" height="14" viewBox="0 0 24 24" fill="none">
                <path d="M20 6L9 17l-5-5" stroke="#111" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </div>
            <div class="flex-1">
              <div class="font-semibold text-[15px] leading-snug">${nm}</div>
            </div>
            <button class="btn-ghost" style="padding:.45rem .9rem" data-remove="${id}" type="button">${escapeHtml(removeText)}</button>
          </div>
        `;
      }).join('');

      postHeightToWix();
    }

    byId('sheet-list').addEventListener('click', (e)=>{
      const btn = e.target.closest('[data-remove]');
      if (!btn) return;
      const id = String(btn.getAttribute('data-remove') || '');
      if (!id) return;
      state.selectedParts.delete(id);
      renderPartsTab(partsUI.activeTab);
      updateStep3Buttons();
      renderSheet();
    });

    // ----------------- STEP 4 -----------------
    function renderStep4List(tab){
      byId('tab-step4-extras').classList.toggle('active', tab==='extras');
      byId('tab-step4-extras').setAttribute('aria-selected', tab==='extras' ? 'true' : 'false');
      byId('tab-step4-servicios').classList.toggle('active', tab==='servicios');
      byId('tab-step4-servicios').setAttribute('aria-selected', tab==='servicios' ? 'true' : 'false');

      const listEl = byId('step4-list');
      const list = (tab === 'extras') ? (appData.extrasList||[]) : (appData.serviciosList||[]);
      const selectedSet = (tab === 'extras') ? state.selectedExtras : state.selectedServicios;

      listEl.setAttribute('data-step4-tab', tab);

      if (!list.length){
        listEl.innerHTML = `<div class="text-sm text-slate-300">No hay opciones configuradas.</div>`;
        updateStep4Count();
        postHeightToWix();
        return;
      }

      listEl.innerHTML = list.map(it=>{
        const id = String(it.price_id);
        const selected = selectedSet.has(id);
        return rowTemplatePrice({ price_id:id, name:it.name }, selected);
      }).join('');

      updateStep4Count();
      postHeightToWix();
    }

    function updateStep4Count(){
      const count = state.selectedExtras.size + state.selectedServicios.size;
      const none = uiLabel('step4_none_selected', 'Ninguno seleccionado');
      byId('step4-count').textContent = count > 0 ? `Seleccionados: ${count}` : none;
    }

    byId('step4-list').addEventListener('click', (e)=>{
      const btn = e.target.closest('[data-id]');
      if (!btn) return;
      const id = String(btn.getAttribute('data-id')||'');
      if (!id) return;

      const tab = byId('step4-list').getAttribute('data-step4-tab') || 'extras';
      if (tab === 'extras'){
        if (state.selectedExtras.has(id)) state.selectedExtras.delete(id);
        else state.selectedExtras.add(id);
      } else {
        if (state.selectedServicios.has(id)) state.selectedServicios.delete(id);
        else state.selectedServicios.add(id);
      }
      renderStep4List(tab);
    });

    // ----------------- STEP 5: send channel UI -----------------
    function setSendChannel(ch){
      state.send_channel = (ch === 'whatsapp') ? 'whatsapp' : 'email';
      byId('send-tab-wa').classList.toggle('active', state.send_channel === 'whatsapp');
      byId('send-tab-wa').setAttribute('aria-selected', state.send_channel === 'whatsapp' ? 'true' : 'false');
      byId('send-tab-email').classList.toggle('active', state.send_channel === 'email');
      byId('send-tab-email').setAttribute('aria-selected', state.send_channel === 'email' ? 'true' : 'false');
    }

    // ----------------- Inline validation -----------------
    function emailValid(v){
      const s = String(v||'').trim().toLowerCase();
      const re = /^[a-z0-9._-]+@[a-z0-9.-]+\.[a-z]{2,}$/i;
      if (s.includes('..')) return false;
      return re.test(s);
    }

    function markField(el, ok){
      if (!el) return;
      el.classList.toggle('invalid', !ok);
      el.classList.toggle('valid', ok);
    }
    function clearFieldMark(el){
      if (!el) return;
      el.classList.remove('invalid','valid');
    }
    function setFieldHint(id, text){
      const el = byId(id);
      if (!el) return;
      if (!text){
        el.classList.add('hidden');
        el.textContent = '';
      } else {
        el.classList.remove('hidden');
        el.textContent = text;
      }
      postHeightToWix();
    }

    function validateName(){
      const el = byId('name_client');
      const v = (el.value||'').trim();
      const ok = v.length >= 2;
      markField(el, ok);
      setFieldHint('name-hint', ok ? '' : 'Escribe tu nombre (m칤nimo 2 caracteres).');
      return ok;
    }

    function basicPhoneFallbackOk(raw){
      const s = String(raw||'').trim();
      if (!s) return false;
      const digits = s.replace(/[^\d]/g,'');
      if (digits.length < 8 || digits.length > 16) return false;
      return true;
    }

    function validatePhone(){
      const el = byId('phone');
      const raw = (el.value||'').trim();

      if (!raw){
        markField(el, false);
        setFieldHint('phone-hint', 'Introduce tu tel칠fono.');
        return false;
      }

      // intl-tel-input not initialized -> fallback mode
      if (!iti){
        const ok = basicPhoneFallbackOk(raw);
        markField(el, ok);
        setFieldHint('phone-hint', ok ? '' : 'Tel칠fono inv치lido. Revisa el n칰mero.');
        return ok;
      }

      // utils still not ready -> fallback mode
      if (!window.intlTelInputUtils){
        const ok = basicPhoneFallbackOk(raw);
        markField(el, ok);
        setFieldHint('phone-hint', ok ? '' : 'Tel칠fono inv치lido. Revisa el prefijo y el n칰mero.');
        return ok;
      }

      const ok = iti.isValidNumber();
      markField(el, ok);

      if (!ok){
        const msg = uiLabel('phone_invalid_message', 'Tel칠fono inv치lido. Revisa el prefijo y el n칰mero.');
        setFieldHint('phone-hint', msg);
        return false;
      }

      setFieldHint('phone-hint', '');
      return true;
    }

    function validateEmail(){
      const el = byId('email_client');
      const v = (el.value||'').trim();
      const ok = emailValid(v);
      markField(el, ok);
      setFieldHint('email-hint', ok ? '' : 'Email inv치lido.');
      return ok;
    }

    function validateConsent(){
      const checked = byId('consent')?.checked;
      if (!checked){
        setFieldHint('consent-hint', 'Debes aceptar la pol칤tica de privacidad para continuar.');
        return false;
      }
      setFieldHint('consent-hint', '');
      return true;
    }

    function step5Valid(){
      return validateName() && validatePhone() && validateEmail() && validateConsent();
    }

    // ----------------- intl-tel-input: wait utils + warnings + debounce -----------------
    async function waitForIntlTelUtils(timeoutMs = 3000){
      const start = Date.now();
      while (Date.now() - start < timeoutMs){
        if (window.intlTelInputUtils) return true;
        await new Promise(r => setTimeout(r, 80));
      }
      return false;
    }

    async function initIntlTelInput(){
      const phoneInput = byId('phone');
      if (!phoneInput){
        return;
      }

      // placeholder from UI config
      phoneInput.placeholder = placeholderText('phone_placeholder', '+34 600 00 00 00');

      if (!window.intlTelInput){
        setFieldHint('phone-hint', 'No se pudo cargar el m칩dulo del tel칠fono. Puedes escribir el n칰mero, pero la validaci칩n ser치 limitada.');
        return;
      }

      iti = window.intlTelInput(phoneInput, {
        initialCountry: "es",
        separateDialCode: false,
        nationalMode: false,
        autoPlaceholder: "polite",
        formatOnDisplay: true,
        utilsScript: "https://cdn.jsdelivr.net/npm/intl-tel-input@23.8.0/build/js/utils.js"
      });

      const utilsReady = await waitForIntlTelUtils(3500);
      if (!utilsReady){
        setFieldHint('phone-hint', 'Validaci칩n del tel칠fono: modo limitado (cargando recursos...).');
      }

      phoneInput.addEventListener('blur', validatePhone);

      // debounce on input
      let phoneT = null;
      phoneInput.addEventListener('input', () => {
        if (phoneT) clearTimeout(phoneT);
        phoneT = setTimeout(() => {
          if (!byId('phone-hint').classList.contains('hidden')) validatePhone();
        }, 250);
      });

      phoneInput.addEventListener('countrychange', () => {
        if (!byId('phone-hint').classList.contains('hidden')) validatePhone();
      });
    }

    // ----------------- Payload helpers -----------------
    function getPhoneE164(){
      if (!iti){
        return (byId('phone')?.value || '').trim();
      }
      try { return iti.getNumber(); } catch(e){ return (byId('phone')?.value || '').trim(); }
    }

    function getPhoneCountry(){
      if (!iti) return '';
      try {
        const c = iti.getSelectedCountryData();
        return (c && c.iso2) ? String(c.iso2) : '';
      } catch(e){ return ''; }
    }

    function collectPayload(){
      const cat = appData.partsCatalog;
      const allParts = [...cat.frontal, ...cat.lateral, ...cat.trasera];

      const idToName = new Map(allParts.map(x=>[String(x.price_id), x.name]));
      const extrasNames = (appData.extrasList||[]).reduce((m,x)=> (m.set(String(x.price_id), x.name), m), new Map());
      const servNames   = (appData.serviciosList||[]).reduce((m,x)=> (m.set(String(x.price_id), x.name), m), new Map());

      const selectedPartsNames = [...state.selectedParts].map(id=>idToName.get(String(id))).filter(Boolean);
      const selectedExtrasNames = [...state.selectedExtras].map(id=>extrasNames.get(String(id))).filter(Boolean);
      const selectedServiciosNames = [...state.selectedServicios].map(id=>servNames.get(String(id))).filter(Boolean);

      const servicePartialAll = [...selectedPartsNames, ...selectedExtrasNames, ...selectedServiciosNames];

      const consentAt = new Date().toISOString();

      const phoneE164 = getPhoneE164();
      const phoneCountry = getPhoneCountry();

      return {
        name_client: (byId('name_client')?.value || '').trim(),
        email_client: (byId('email_client')?.value || '').trim(),

        phone: phoneE164,
        phone_country: phoneCountry,

        marca: state.brand || byId('brand').value || '',
        modelo: state.model || byId('model').value || '',
        a침o: state.year || byId('year').value || '',

        install_center_id: state.install_center_id,
        install_center: state.install_center_title,

        service_basic: state.flow === 'total' ? (state.selectedPackage || '') : '',
        service_partial: servicePartialAll.join(', '),

        marca_ppf: state.finish_key || state.finish_title,
        finish_key: state.finish_key,
        finish_title: state.finish_title,

        flow: state.flow,
        check_promotion: byId('promo')?.checked ? 'Checked' : '',
        comment: (byId('comment')?.value || '').trim(),

        mode: 'text',
        send_channel: state.send_channel,

        consent_at: consentAt,
        consent_policy_url: PRIVACY_URL,

        privacy_policy_accepted: !!byId('consent')?.checked
      };
    }

    // ----------------- Webhook POST -----------------
    async function postToWebhook(payload, { silent = false } = {}){
      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), 10000);

      try{
        const res = await fetch(WEBHOOK_URL, {
          method: 'POST',
          mode: 'cors',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ data: payload }),
          signal: controller.signal
        });

        if (!res.ok){
          const txt = await res.text().catch(()=> '');
          throw new Error(txt ? `Server error: ${txt}` : `Server error: ${res.status}`);
        }

        try { await res.json(); } catch(e){}
      } catch(e){
        if (e && e.name === 'AbortError'){
          throw new Error('Tiempo de espera agotado. Int칠ntalo de nuevo.');
        }
        throw e;
      } finally {
        clearTimeout(timeoutId);
      }
    }

    // ----------------- FULL RESET AFTER SUCCESS -----------------
    async function resetFormAfterSuccess(){
      setMsg('');
      byId('step1-hint').textContent = '';
      byId('step2-hint').textContent = '';
      byId('step3-hint').textContent = '';
      byId('step4-hint').textContent = '';
      setFieldHint('name-hint','');
      setFieldHint('phone-hint','');
      setFieldHint('email-hint','');
      setFieldHint('consent-hint','');

      clearFieldMark(byId('name_client'));
      clearFieldMark(byId('phone'));
      clearFieldMark(byId('email_client'));

      byId('name_client').value = '';
      byId('email_client').value = '';
      byId('comment').value = '';
      byId('promo').checked = false;
      byId('consent').checked = false;

      if (iti){
        byId('phone').value = '';
        try { iti.setNumber(''); } catch(e){}
      } else {
        byId('phone').value = '';
      }

      state.flow = '';
      state.brand = '';
      state.model = '';
      state.year = '';
      state.install_center_id = '';
      state.install_center_title = '';
      state.finish_key = '';
      state.finish_title = '';
      state.finish_allow_partial = true;
      state.finish_warning_partial = '';
      state.selectedPackage = '';
      state.selectedParts.clear();
      state.selectedExtras.clear();
      state.selectedServicios.clear();
      state.send_channel = 'email';
      state.step4BackTarget = 3;
      state.startedAt = Date.now();

      byId('brand').value = '';
      await loadModels('');
      byId('year').value = '';
      byId('finish').value = '';
      byId('finish_parts').value = '';
      byId('install_center').value = '';

      setFlow('');

      byId('block-packages').classList.add('hidden');
      byId('block-parts').classList.add('hidden');
      byId('step3-nav').classList.remove('hidden');
      byId('pack-warning-box').classList.add('hidden');
      byId('parts-warning-box').classList.add('hidden');
      byId('pack-warning-body').textContent = '';
      byId('parts-warning-body').textContent = '';

      updatePackagesInfoUI();
      updateStep3Buttons();
      renderStep4List('extras');
      updateStep4Count();
      updateViewButtonCount();
      closeSheet();

      setSendChannel('email');

      byId('submit-text').textContent = uiLabel('btn_submit', 'Enviar presupuesto');

      showStep(1);
      updateStep1UI();
      postHeightToWix();
    }

    // ----------------- Submit protections -----------------
    async function submitForm(){
      setMsg('');

      const now = Date.now();
      if (now - state.lastSubmitAt < 3000){
        setMsg('Por favor espera un momento antes de reenviar.', false);
        return;
      }
      state.lastSubmitAt = now;

      if (state.submitting) return;
      state.submitting = true;

      const btn = byId('submit');
      const submitText = byId('submit-text');
      const submitSpinner = byId('submit-spinner');

      btn.disabled = true;
      submitText.classList.add('hidden');
      submitSpinner.classList.remove('hidden');

      try{
        // single source of truth for contact validation
        if (!step5Valid()) {
          throw new Error('Por favor completa todos los campos obligatorios correctamente.');
        }

        const miss = step1MissingFields();
        if (miss.length) throw new Error('Faltan datos del coche: ' + miss.join(', ') + '.');

        trackEvent('generate_lead', {
          car_brand: state.brand || byId('brand').value || '',
          service_flow: state.flow || '',
          finish_type: state.finish_key || ''
        });

        const payload = collectPayload();

        await postToWebhook(payload);
        setMsg('Enviado. Te contactaremos lo antes posible.', true);

        trackEvent('form_submitted_success', {
          flow: state.flow,
          send_channel: state.send_channel,
          time_to_complete: Math.round((Date.now() - state.startedAt) / 1000)
        });

        if (window.fbq){
          fbq('track', 'Lead', {
            content_name: state.flow,
            value: 1,
            currency: 'EUR'
          });
        }

        await resetFormAfterSuccess();

      } catch(e){
        console.error('submit:', e);

        const errMsg = e?.message || String(e || '');

        // Validation errors: don't enqueue
        const isValidation = /completa|obligatorios|inv치lido|aceptar|faltan/i.test(errMsg);

        if (isValidation){
          setMsg('Error: ' + errMsg, false);
          trackEvent('form_submit_validation_error', { flow: state.flow, error: errMsg });
        } else {
          // Network/webhook errors: enqueue lead
          try{
            const payload = collectPayload();
            enqueuePending(payload);
            setMsg('No se pudo enviar ahora. Guardamos tu solicitud y la reintentaremos autom치ticamente.', true);
            trackEvent('form_submit_failed_queued', { flow: state.flow, error: errMsg });
          } catch(qe){
            setMsg('Error: ' + errMsg, false);
            trackEvent('form_submit_failed_network', { flow: state.flow, error: errMsg });
          }
        }
      } finally {
        btn.disabled = false;
        submitText.classList.remove('hidden');
        submitSpinner.classList.add('hidden');
        state.submitting = false;
      }
    }

    // ----------------- Keyboard navigation -----------------
    function initKeyboardNav(){
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && byId('sheet').classList.contains('open')){
          closeSheet();
          e.preventDefault();
        }

        if ((e.key === 'ArrowLeft' || e.key === 'ArrowRight') &&
            e.target.closest('[role="tablist"]')){
          const tablist = e.target.closest('[role="tablist"]');
          const tabs = [...tablist.querySelectorAll('button[role="tab"]')];
          const idx = tabs.indexOf(e.target);
          if (idx === -1) return;

          const next = e.key === 'ArrowRight'
            ? tabs[(idx + 1) % tabs.length]
            : tabs[(idx - 1 + tabs.length) % tabs.length];

          next.focus();
          next.click();
          e.preventDefault();
        }
      });
    }

    // ----------------- INIT -----------------
    async function init(){
      trackEvent('form_page_view', { referrer: document.referrer || 'direct' });

      // try to flush queued leads (best effort)
      flushPending().then(()=>{}).catch(()=>{});

      // initIntlTelInput().then(()=>{}).catch(()=>{});
      await Promise.all([
        loadUIFields(),
        loadBrands(),
        loadModels(''),
        loadYears(),
        loadInstallCenters(),
        loadFinishes()
      ]);

      await loadPriceUI();

      if (ui.ready) applyUI();

      // Step1 listeners
      byId('brand').addEventListener('change', async (e)=>{
        state.brand = e.target.value || '';
        state.model = '';
        byId('model').value = '';
        await loadModels(state.brand);
        updateStep1UI();
      });

      byId('model').addEventListener('change', (e)=>{ state.model = e.target.value || ''; updateStep1UI(); });
      byId('year').addEventListener('change', (e)=>{ state.year = e.target.value || ''; updateStep1UI(); });

      byId('install_center').addEventListener('change', (e)=>{
        state.install_center_id = e.target.value || '';
        const r = appData.centers.get(String(state.install_center_id));
        state.install_center_title = r?.title || '';
      });

      updateStep1UI();

      // Nav step1
      byId('next-1').addEventListener('click', ()=>{
        const miss = step1MissingFields();
        if (miss.length){
          byId('step1-hint').textContent = 'Falta completar: ' + miss.join(', ') + '.';
          postHeightToWix();
          return;
        }
        byId('step1-hint').textContent = '';
        showStep(2);
      });

      // Flow
      byId('card-total').addEventListener('click', ()=> setFlow('total'));
      byId('card-custom').addEventListener('click', ()=> setFlow('custom'));
      byId('card-otros').addEventListener('click', ()=> setFlow('otros'));

      byId('back-2').addEventListener('click', ()=> showStep(1));
      byId('next-2').addEventListener('click', ()=>{
        if (!state.flow){
          byId('step2-hint').textContent = 'Selecciona una opci칩n.';
          postHeightToWix();
          return;
        }
        byId('step2-hint').textContent = '';
        showStep(3);
        enterStep3();
      });

      function syncFinish(sourceId){
        const val = byId(sourceId).value || '';
        setFinishFromKey(val);
        ['finish','finish_parts'].forEach(id => {
          if (id !== sourceId) byId(id).value = val;
        });
        updatePartialWarningUI();
        updateStep3Buttons();
      }

      byId('finish').addEventListener('change', ()=> syncFinish('finish'));
      byId('finish_parts').addEventListener('change', ()=> syncFinish('finish_parts'));

      // Step 3 nav (packages)
      byId('back-3').addEventListener('click', ()=> showStep(2));
      byId('next-3').addEventListener('click', ()=>{
        if (!state.selectedPackage) { byId('step3-hint').textContent = 'Selecciona un paquete.'; postHeightToWix(); return; }
        if (!state.finish_key) { byId('step3-hint').textContent = 'Selecciona el tipo de cobertura.'; postHeightToWix(); return; }
        byId('step3-hint').textContent = '';
        state.step4BackTarget = 3;
        showStep(4);
      });

      // Step 3B parts nav
      byId('back-3b').addEventListener('click', ()=> showStep(2));
      byId('next-3b').addEventListener('click', ()=>{
        if (!state.finish_key) { byId('step3-hint').textContent = 'Selecciona el tipo de cobertura.'; postHeightToWix(); return; }
        if (state.selectedParts.size === 0) { byId('step3-hint').textContent = 'Selecciona al menos una parte.'; postHeightToWix(); return; }
        byId('step3-hint').textContent = '';
        state.step4BackTarget = 3;
        showStep(4);
      });

      // Parts tabs
      byId('tab-frontal').addEventListener('click', ()=> renderPartsTab('frontal'));
      byId('tab-lateral').addEventListener('click', ()=> renderPartsTab('lateral'));
      byId('tab-trasera').addEventListener('click', ()=> renderPartsTab('trasera'));

      // Sheet
      byId('btn-view').addEventListener('click', openSheet);
      byId('btn-close').addEventListener('click', closeSheet);
      byId('backdrop').addEventListener('click', closeSheet);

      // Step 4
      byId('tab-step4-extras').addEventListener('click', ()=> renderStep4List('extras'));
      byId('tab-step4-servicios').addEventListener('click', ()=> renderStep4List('servicios'));

      byId('back-4').addEventListener('click', ()=>{
        const target = state.step4BackTarget || 3;
        if (target === 2){
          showStep(2);
          return;
        }
        showStep(3);
        enterStep3();
      });

      byId('next-4').addEventListener('click', ()=> showStep(5));

      // Step 5
      byId('back-5').addEventListener('click', ()=> showStep(4));

      // send channel tabs
      byId('send-tab-wa').addEventListener('click', ()=> setSendChannel('whatsapp'));
      byId('send-tab-email').addEventListener('click', ()=> setSendChannel('email'));
      setSendChannel(state.send_channel);

      // Inline validation listeners
      byId('name_client').addEventListener('blur', validateName);
      byId('email_client').addEventListener('blur', validateEmail);
      byId('consent').addEventListener('change', validateConsent);

      byId('name_client').addEventListener('input', ()=> {
        if (!byId('name-hint').classList.contains('hidden')) validateName();
      });

      byId('email_client').addEventListener('input', ()=> {
        if (!byId('email-hint').classList.contains('hidden')) validateEmail();
      });

      byId('submit').addEventListener('click', submitForm);

      initKeyboardNav();

      // Initial screen
      showStep(1);
      setFlow('');
      setFinishFromKey('');
      updatePackagesInfoUI();
      updatePartialWarningUI();
      updateStep3Buttons();

      setText('next-1', uiLabel('btn_next_1', byId('next-1')?.textContent || 'Continuar'));

      // final height sync
      postHeightToWix();
      setTimeout(postHeightToWix, 150);
      setTimeout(postHeightToWix, 450);
    }

    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
